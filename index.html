<!-- 
    AUTHFLOW - DESKTOP VERSION
    ==========================
    Version: 24.0.0-Sentinel (SECURITY PATCHED)
    Architecture: Monolithic Single-File SPA
    Engine: Vanilla JS + Firebase SDK + TailwindCSS + Canvas + AudioEngine
    
    AUTHOR: Adhyasthareihan@gmail.com
    CREDITS: ItsSkellyHer3
    STATUS: SECURE (XSS Fixed + DM Fixed + Admin Panel)
-->

<!DOCTYPE html>
<html lang="en" data-theme="midnight">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AuthFlow - Desktop Version">
    <meta name="author" content="ItsSkellyHer3">
    <title>AuthFlow - Desktop Version</title>

    <!-- ================================================================================= -->
    <!-- CORE DEPENDENCIES (CDNs)                                                          -->
    <!-- ================================================================================= -->
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Nunito+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Utilities -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/calendar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/localizedFormat.js"></script>
    
    <!-- Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- ================================================================================= -->
    <!-- CONFIGURATION & THEME ENGINE                                                      -->
    <!-- ================================================================================= -->
    <script>
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.extend(window.dayjs_plugin_calendar);
        dayjs.extend(window.dayjs_plugin_localizedFormat);
        
        // Marked: Disable HTML input by default for safety
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false,
            pedantic: false,
            smartLists: true,
            smartypants: true,
            sanitize: false // We handle sanitization manually with DOMPurify
        });

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: 'var(--bg-primary)',
                        sidebar: 'var(--bg-secondary)',
                        panel: 'var(--bg-tertiary)',
                        surface: 'var(--bg-modifier-hover)',
                        active: 'var(--bg-modifier-active)',
                        border: 'var(--border-color)',
                        header: 'var(--header-primary)',
                        text: 'var(--text-normal)',
                        muted: 'var(--text-muted)',
                        accent: 'var(--brand-experiment)',
                        accentHover: 'var(--brand-experiment-560)',
                        danger: 'var(--text-danger)',
                        success: 'var(--text-positive)',
                        warn: 'var(--text-warning)',
                        link: 'var(--text-link)',
                        
                        roleOwner: '#E67E22', 
                        roleAdmin: '#E91E63', 
                        roleNitro: '#ff73fa', 
                        roleUser: '#99AAB5', 
                    },
                    fontFamily: {
                        sans: ['"Nunito Sans"', '"Inter"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                        display: ['"Inter"', 'sans-serif'],
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'bounce-soft': 'bounce 2s infinite',
                        'fade-in': 'fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'fade-out': 'fadeOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'scale-in': 'scaleIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'slide-right': 'slideRight 0.3s ease-out forwards',
                        'shimmer': 'shimmer 2s linear infinite',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'spin-logo': 'spinLogo 2s cubic-bezier(0.4, 0, 0.2, 1) infinite',
                        'scan': 'scan 2s linear infinite',
                        'rainbow': 'rainbow 5s linear infinite',
                        'modal-bounce': 'modalBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'flash': 'flash 1s',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeOut: { '0%': { opacity: '1' }, '100%': { opacity: '0' } },
                        scaleIn: { '0%': { transform: 'scale(0.9) opacity(0)' }, '100%': { transform: 'scale(1) opacity(1)' } },
                        slideUp: { '0%': { transform: 'translateY(20px) opacity(0)' }, '100%': { transform: 'translateY(0) opacity(1)' } },
                        slideRight: { '0%': { transform: 'translateX(-20px) opacity(0)' }, '100%': { transform: 'translateX(0) opacity(1)' } },
                        shimmer: { '0%': { backgroundPosition: '-1000px 0' }, '100%': { backgroundPosition: '1000px 0' } },
                        pulseGlow: { '0%, 100%': { boxShadow: '0 0 10px var(--brand-experiment)' }, '50%': { boxShadow: '0 0 25px var(--brand-experiment)' } },
                        spinLogo: { '0%': { transform: 'rotate(0deg) scale(1)' }, '50%': { transform: 'rotate(180deg) scale(1.1)' }, '100%': { transform: 'rotate(360deg) scale(1)' } },
                        scan: { '0%': { top: '0%' }, '50%': { top: '100%' }, '100%': { top: '0%' } },
                        rainbow: { '0%': { borderColor: 'red', color: 'red' }, '20%': { borderColor: 'orange', color: 'orange' }, '40%': { borderColor: 'yellow', color: 'yellow' }, '60%': { borderColor: 'green', color: 'green' }, '80%': { borderColor: 'blue', color: 'blue' }, '100%': { borderColor: 'violet', color: 'violet' } },
                        modalBounce: { '0%': { transform: 'scale(0.8) translateY(20px)', opacity: 0 }, '100%': { transform: 'scale(1) translateY(0)', opacity: 1 } },
                        flash: { '0%, 100%': { backgroundColor: 'transparent' }, '50%': { backgroundColor: 'rgba(255, 255, 255, 0.1)' } }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.36)',
                        'popout': '0 8px 24px rgba(0,0,0,0.5)',
                        'elevation-low': '0 1px 0 rgba(4,4,5,0.2),0 1.5px 0 rgba(6,6,7,0.05),0 2px 0 rgba(4,4,5,0.05)',
                        'elevation-high': '0 8px 16px rgba(0,0,0,0.24)',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            /* DEFAULT (Midnight/Discord Dark) */
            --bg-primary: #313338;
            --bg-secondary: #2b2d31;
            --bg-tertiary: #1e1f22;
            --bg-modifier-hover: rgba(79, 84, 92, 0.32); 
            --bg-modifier-active: rgba(79, 84, 92, 0.48);
            --border-color: #1f2023;
            --header-primary: #f2f3f5;
            --text-normal: #dbdee1;
            --text-muted: #949ba4;
            --text-link: #00a8fc;
            --text-danger: #fa777c;
            --text-positive: #23a559;
            --text-warning: #f0b232;
            --brand-experiment: #5865F2;
            --brand-experiment-560: #4752C4;
            --scrollbar-thumb: #1a1b1e;
            --scrollbar-track: #2b2d31;
            --status-online: #23a559;
            --status-idle: #f0b232;
            --status-dnd: #f23f43;
            --status-offline: #80848e;
            --app-zoom: 1; 
        }

        [data-theme="synthwave"] {
            --bg-primary: #2b213a;
            --bg-secondary: #241b2f;
            --bg-tertiary: #1a1323;
            --bg-modifier-hover: rgba(255, 113, 206, 0.15);
            --bg-modifier-active: rgba(255, 113, 206, 0.25);
            --border-color: #372948;
            --header-primary: #fff;
            --text-normal: #fff0f5;
            --text-muted: #b8a3c9;
            --text-link: #01cdfe;
            --text-danger: #ff0055;
            --text-positive: #05ffa1;
            --text-warning: #ffd700;
            --brand-experiment: #b967ff;
            --brand-experiment-560: #8c42d1;
            --scrollbar-thumb: #b967ff;
            --scrollbar-track: #1a1323;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f2f3f5;
            --bg-tertiary: #ebedef;
            --bg-modifier-hover: rgba(0, 0, 0, 0.08);
            --bg-modifier-active: rgba(0, 0, 0, 0.16);
            --border-color: #e3e5e8;
            --header-primary: #060607;
            --text-normal: #313338;
            --text-muted: #5c5e66;
            --brand-experiment: #5865F2;
            --brand-experiment-560: #4752C4;
            --scrollbar-thumb: #e3e5e8;
            --scrollbar-track: #f2f3f5;
        }
        
        [data-theme="custom"] {
            --bg-primary: var(--custom-bg);
            --bg-secondary: var(--custom-sidebar);
            --bg-tertiary: var(--custom-panel);
            --header-primary: var(--custom-text);
            --brand-experiment: var(--custom-accent);
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-normal);
            font-family: var(--font-body);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #app-layer { zoom: var(--app-zoom); }

        body.rgb-mode * {
            border-color: transparent;
            animation: rainbow 5s linear infinite;
        }
        body.rgb-mode .border-r, body.rgb-mode .border-b, body.rgb-mode .border-t, body.rgb-mode .border {
            border-width: 1px;
            border-style: solid;
        }

        body.compact-mode .msg-content { margin-left: 0 !important; }
        body.compact-mode .channel-item { padding-top: 0; padding-bottom: 0; }
        body.compact-mode img.w-10 { display: none; }

        body.bubble-mode .msg-content {
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 0 12px 12px 12px;
            display: inline-block;
            max-width: 80%;
        }

        .scroller {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
        }
        .scroller::-webkit-scrollbar { width: 8px; height: 8px; }
        .scroller::-webkit-scrollbar-track { background-color: var(--scrollbar-track); border-radius: 4px; }
        .scroller::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 4px; border: 2px solid var(--scrollbar-track); }
        .scroller::-webkit-scrollbar-thumb:hover { background-color: var(--text-muted); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .mac-code-block {
            margin: 16px 0;
            background: #1e1e1e; 
            border-radius: 8px;
            border: 1px solid #000000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            overflow: hidden;
            font-family: 'JetBrains Mono', monospace;
            max-width: 100%;
        }
        .mac-header {
            background: #252526;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            user-select: none;
        }
        .mac-lights { display: flex; gap: 8px; }
        .light { width: 12px; height: 12px; border-radius: 50%; transition: transform 0.1s; }
        .light:hover { transform: scale(1.1); }
        .light.red { background-color: #ff5f56; }
        .light.yellow { background-color: #ffbd2e; }
        .light.green { background-color: #27c93f; }
        
        .mac-actions { display: flex; gap: 10px; align-items: center; }
        .mac-lang { color: #858585; font-size: 11px; text-transform: uppercase; font-weight: bold; }
        .mac-btn { cursor: pointer; color: #ccc; font-size: 12px; transition: color 0.2s; padding: 4px; border-radius: 4px; display: flex; align-items: center; gap: 4px; }
        .mac-btn:hover { color: white; background: rgba(255,255,255,0.1); }

        .mac-body { padding: 0; overflow-x: auto; background: #1e1e1e; }
        .mac-body pre { margin: 0; padding: 16px; font-size: 13px; line-height: 1.5; color: #d4d4d4; }
        .mac-body code { font-family: 'JetBrains Mono', monospace; background: transparent !important; padding: 0 !important; }

        .msg-content { user-select: text; word-wrap: break-word; }
        .msg-content a { color: var(--text-link); text-decoration: none; }
        .msg-content a:hover { text-decoration: underline; }
        .msg-content blockquote { border-left: 4px solid var(--bg-tertiary); padding-left: 12px; color: var(--text-muted); margin: 4px 0; }
        .msg-content code { background: var(--bg-tertiary); padding: 2px 4px; border-radius: 3px; font-size: 85%; font-family: 'JetBrains Mono', monospace; }
        .msg-content strong { font-weight: 700; color: var(--header-primary); }
        .msg-content img { max-width: 100%; border-radius: 8px; margin-top: 8px; cursor: pointer; transition: transform 0.2s; }
        .msg-content img:hover { transform: scale(1.01); }
        
        .spoiler { background-color: #202225; color: transparent; border-radius: 3px; cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .spoiler:hover { background-color: #292b2f; }
        .spoiler.revealed { background-color: #2f3136; color: var(--text-normal); cursor: text; user-select: text; }
        
        .mention { background-color: rgba(250, 166, 26, 0.1); color: #faa61a; border-radius: 3px; padding: 0 2px; font-weight: 500; cursor: pointer; }
        .mention:hover { background-color: rgba(250, 166, 26, 0.2); text-decoration: underline; }
        
        .msg-highlighted {
            background-color: rgba(250, 166, 26, 0.1) !important;
            border-left: 2px solid #faa61a;
        }

        .reply-elbow {
            position: absolute; left: 34px; top: 10px; width: 30px; height: 12px;
            border-left: 2px solid var(--border-color); border-top: 2px solid var(--border-color);
            border-top-left-radius: 6px; opacity: 0.5;
        }

        .rainbow-text {
            background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 5s linear infinite;
            font-weight: 800;
        }

        .glass-modal {
            background: rgba(18, 18, 18, 0.90);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: modal-bounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .role-badge {
            display: inline-flex;
            align-items: center;
            padding: 0 4px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            height: 16px;
            margin-left: 6px;
            color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .glow-text { text-shadow: 0 0 10px currentColor; }
        
        .channel-item:active { transform: translateY(1px); }
        .context-item:hover { background-color: var(--brand-experiment); color: white; }
        .context-item.danger:hover { background-color: var(--text-danger); color: white; }
    </style>
</head>
<body>

    <!-- LAYER 1: SYSTEM BOOT & LOADER -->
    <div id="boot-layer" class="fixed inset-0 z-[9999] bg-[#1e1f22] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="flex flex-col items-center space-y-6 animate-bounce-soft">
            <div class="w-24 h-24 bg-[#5865F2] rounded-full flex items-center justify-center shadow-lg animate-spin-logo">
                <i class="fa-brands fa-discord text-5xl text-white"></i>
            </div>
            <h1 class="text-2xl font-black text-white tracking-wider">AUTHFLOW</h1>
        </div>
        
        <div class="w-64 h-2 bg-[#2b2d31] rounded-full mt-8 overflow-hidden relative">
            <div class="absolute top-0 left-0 h-full w-1/3 bg-[#5865F2] animate-shimmer"></div>
        </div>

        <div id="boot-tip" class="text-muted text-xs font-bold opacity-80 mt-4 max-w-md text-center transition-opacity duration-500 uppercase tracking-widest">Initializing Uplink...</div>
        <div id="boot-status" class="text-muted text-[10px] mt-2 opacity-50 font-mono">Connecting to Firebase Gateway...</div>
        
        <button id="force-entry-btn" class="hidden mt-8 bg-danger text-white px-4 py-2 rounded text-xs font-bold hover:bg-red-600 transition-colors shadow-lg" onclick="Boot.forceEntry()">
            ⚠️ Emergency Override (Safe Mode)
        </button>

        <div class="absolute bottom-8 text-[10px] text-muted/30 font-mono">Sentinel Core v24.0.0 | System Online</div>
    </div>

    <!-- LAYER 2: AUTHENTICATION PORTAL -->
    <div id="auth-layer" class="fixed inset-0 z-[5000] bg-[#1e1f22] hidden flex items-center justify-center overflow-hidden">
        <canvas id="particles-canvas" class="absolute inset-0 z-0"></canvas>
        <div class="flex flex-col items-center animate-scale-in z-10">
            <div class="mb-6 flex items-center gap-3">
                <i class="fa-brands fa-discord text-4xl text-white"></i>
                <h1 class="text-3xl font-black text-white tracking-tight font-display">AuthFlow - Desktop</h1>
            </div>

            <div class="flex w-[784px] h-[480px] bg-[#313338] rounded-[5px] shadow-2xl overflow-hidden relative border border-white/5 backdrop-blur-xl">
                <div class="w-[480px] p-8 flex flex-col justify-center bg-[#313338]/90">
                    <div class="mb-6 text-center">
                        <h2 class="text-2xl font-bold text-white mb-2" id="auth-title">Welcome Back!</h2>
                        <p class="text-[#B5BAC1] text-sm" id="auth-subtitle">We're so excited to see you again!</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-[#B5BAC1] uppercase mb-2">Email or Phone Number <span class="text-danger">*</span></label>
                            <div class="bg-[#1E1F22] rounded-[3px] p-2.5 transition-colors focus-within:ring-1 focus-within:ring-[#00A8FC]">
                                <input type="text" id="login-email" class="bg-transparent w-full outline-none text-white text-base font-medium" placeholder="">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#B5BAC1] uppercase mb-2">Password <span class="text-danger">*</span></label>
                            <div class="bg-[#1E1F22] rounded-[3px] p-2.5 transition-colors focus-within:ring-1 focus-within:ring-[#00A8FC]">
                                <input type="password" id="login-pass" class="bg-transparent w-full outline-none text-white text-base font-medium" placeholder="">
                            </div>
                            <div class="text-[#00A8FC] text-xs mt-2 hover:underline cursor-pointer">Forgot your password?</div>
                        </div>

                        <button id="btn-auth-action" onclick="Auth.loginEmail()" class="w-full bg-[#5865F2] hover:bg-[#4752C4] text-white font-bold py-2.5 rounded-[3px] transition-all active:scale-95 flex justify-center items-center gap-2 mt-2 text-base">
                            Log In
                        </button>

                        <div class="flex items-center gap-2 my-2">
                            <div class="h-px bg-[#1E1F22] flex-1"></div>
                            <span class="text-xs text-[#949BA4]">OR</span>
                            <div class="h-px bg-[#1E1F22] flex-1"></div>
                        </div>
                        <button onclick="Auth.google()" class="w-full bg-white hover:bg-[#E5E5E5] text-black font-bold py-2.5 rounded-[3px] transition-all flex justify-center items-center gap-2 text-sm">
                            <i class="fa-brands fa-google"></i> Continue with Google
                        </button>

                        <div class="text-[#949BA4] text-sm mt-1">
                            <span id="auth-switch-text">Need an account?</span> 
                            <span class="text-[#00A8FC] hover:underline cursor-pointer font-medium" onclick="Auth.toggleMode()" id="auth-switch-btn">Register</span>
                            <span class="mx-1 text-[#949BA4]">|</span>
                            <span class="text-[#949BA4] hover:text-white cursor-pointer text-xs" onclick="Auth.anon()">Guest Mode</span>
                        </div>
                    </div>
                </div>

                <div class="flex-1 flex flex-col items-center justify-center p-8 text-center relative overflow-hidden bg-black/20">
                    <div class="w-[176px] h-[176px] bg-white rounded-[4px] p-2 mb-6 shadow-sm relative group cursor-none overflow-hidden">
                        <div class="w-full h-full bg-[url('https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=AuthFlowDesktopLogin')] bg-cover"></div>
                        <div class="absolute inset-0 bg-white/90 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10">
                            <i class="fa-brands fa-discord text-5xl text-[#5865F2] animate-bounce-soft"></i>
                        </div>
                        <div class="absolute w-full h-[2px] bg-[#23a559] shadow-[0_0_4px_#23a559] animate-scan z-0"></div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">Log in with QR Code</h3>
                    <p class="text-[#B5BAC1] text-sm px-2">Scan this with the <strong class="text-white font-medium">AuthFlow Mobile App</strong> to log in instantly.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- LAYER 3: MAIN APPLICATION INTERFACE -->
    <div id="app-layer" class="fixed inset-0 z-0 flex bg-bg opacity-0 transition-opacity duration-700 hidden">
        
        <!-- 3.1 SERVER RAIL -->
        <nav class="w-[72px] bg-tertiary flex flex-col items-center py-3 gap-2 overflow-y-auto no-scrollbar shrink-0 z-30 select-none backdrop-blur-md bg-opacity-90">
            <div class="group relative cursor-pointer" onclick="UI.switchView('dm')">
                <div id="home-indicator" class="absolute left-0 top-1/2 -translate-y-1/2 w-[4px] h-0 bg-header rounded-r transition-all group-hover:h-5"></div>
                <div id="home-icon" class="w-12 h-12 bg-sidebar group-hover:bg-accent rounded-[24px] group-hover:rounded-[16px] transition-all flex items-center justify-center text-header shadow-lg">
                    <i class="fa-brands fa-discord text-xl"></i>
                </div>
                <div class="absolute left-full top-1/2 -translate-y-1/2 ml-4 bg-black text-white text-xs font-bold px-2 py-1 rounded shadow-xl opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity whitespace-nowrap z-50">Direct Messages</div>
            </div>
            <div class="w-8 h-[2px] bg-sidebar rounded opacity-50"></div>
            <div id="server-list" class="flex flex-col gap-2 w-full items-center"></div>
            <div class="group relative cursor-pointer mt-2" onclick="UI.modal('group-create')">
                <div class="w-12 h-12 bg-sidebar group-hover:bg-success rounded-[24px] group-hover:rounded-[16px] transition-all flex items-center justify-center text-success group-hover:text-white">
                    <i class="fa-solid fa-plus text-xl"></i>
                </div>
            </div>
            <div class="group relative cursor-pointer" onclick="UI.modal('join-server')">
                <div class="w-12 h-12 bg-sidebar group-hover:bg-success rounded-[24px] group-hover:rounded-[16px] transition-all flex items-center justify-center text-success group-hover:text-white">
                    <i class="fa-solid fa-compass text-xl"></i>
                </div>
            </div>
        </nav>

        <!-- 3.2 SIDEBAR -->
        <div class="w-60 bg-sidebar flex flex-col shrink-0 rounded-tl-xl border-r border-border overflow-hidden relative backdrop-blur-md bg-opacity-95">
            <header class="h-12 px-4 flex items-center justify-between shadow-md cursor-pointer hover:bg-bg transition-colors z-20" onclick="UI.contextMenu(event, 'server')">
                <h1 class="font-bold text-header text-sm truncate" id="server-name">Loading...</h1>
                <div class="flex items-center gap-2">
                     <i class="fa-solid fa-chevron-down text-xs text-muted" id="server-header-icon" onclick="UI.modal('server-settings'); event.stopPropagation();"></i>
                </div>
            </header>
            <div class="flex-1 scroller p-0 pt-3" id="channel-container">
                <div class="flex flex-col items-center justify-center h-full text-muted text-xs gap-2 opacity-50">
                    <i class="fa-solid fa-ghost text-2xl"></i>
                    <span>No channels yet.</span>
                </div>
            </div>
            <div id="voice-panel" class="bg-[#232428] p-2 border-b border-border hidden flex-col">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2 text-success font-bold text-xs">
                        <i class="fa-solid fa-signal"></i> Voice Connected
                    </div>
                    <i class="fa-solid fa-phone-slash text-muted hover:text-white cursor-pointer" onclick="Voice.leave()"></i>
                </div>
                <div class="text-muted text-xs truncate" id="voice-channel-name">General / Voice</div>
                <canvas id="voice-viz" class="w-full h-8 my-1 bg-black/20 rounded"></canvas>
                <div class="flex gap-2 mt-1">
                    <button class="flex-1 bg-bg hover:bg-surface py-1 rounded text-xs text-white" onclick="UI.toggleVideo()">Video</button>
                    <button class="flex-1 bg-bg hover:bg-surface py-1 rounded text-xs text-white" onclick="UI.toggleScreenShare()">Screen</button>
                </div>
            </div>
            <div class="h-[52px] bg-[#1e1f24] flex items-center px-2 gap-1 shrink-0 border-t border-border z-20">
                <div class="flex items-center gap-2 hover:bg-surface p-1 rounded cursor-pointer transition-colors flex-1 group relative" onclick="UI.toggleStatusMenu()">
                    <div class="relative">
                        <img id="current-user-av" class="w-8 h-8 rounded-full bg-bg object-cover border border-border" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                        <div id="current-user-status" class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-success rounded-full border-[2px] border-[#1e1f24]"></div>
                    </div>
                    <div class="flex flex-col overflow-hidden">
                        <div class="text-xs font-bold text-header truncate w-20" id="current-user-name">...</div>
                        <div class="text-[10px] text-muted truncate" id="current-user-tag">#0000</div>
                    </div>
                    <div id="status-menu" class="absolute bottom-14 left-0 w-48 bg-[#111214] rounded shadow-popout hidden flex-col p-1 z-50 border border-border">
                        <div class="px-2 py-1 text-[10px] font-bold text-muted uppercase">Set Status</div>
                        <div class="h-px bg-border my-1"></div>
                        <div class="flex items-center gap-2 px-2 py-1.5 hover:bg-accent hover:text-white rounded cursor-pointer text-sm text-muted" onclick="User.setStatus('online')">
                            <div class="w-2.5 h-2.5 rounded-full bg-success"></div> Online
                        </div>
                        <div class="flex items-center gap-2 px-2 py-1.5 hover:bg-accent hover:text-white rounded cursor-pointer text-sm text-muted" onclick="User.setStatus('idle')">
                            <div class="w-2.5 h-2.5 rounded-full bg-warn"></div> Idle
                        </div>
                        <div class="flex items-center gap-2 px-2 py-1.5 hover:bg-accent hover:text-white rounded cursor-pointer text-sm text-muted" onclick="User.setStatus('dnd')">
                            <div class="w-2.5 h-2.5 rounded-full bg-danger"></div> Do Not Disturb
                        </div>
                        <div class="flex items-center gap-2 px-2 py-1.5 hover:bg-accent hover:text-white rounded cursor-pointer text-sm text-muted" onclick="User.setStatus('invisible')">
                            <div class="w-2.5 h-2.5 rounded-full bg-gray-500"></div> Invisible
                        </div>
                    </div>
                </div>
                <div class="flex items-center">
                    <button class="w-8 h-8 rounded hover:bg-surface flex items-center justify-center text-muted hover:text-header relative group" onclick="UI.toggleMute()">
                        <i class="fa-solid fa-microphone text-xs" id="icon-mic"></i>
                    </button>
                    <button class="w-8 h-8 rounded hover:bg-surface flex items-center justify-center text-muted hover:text-header relative group" onclick="UI.toggleDeafen()">
                        <i class="fa-solid fa-headphones text-xs" id="icon-deaf"></i>
                    </button>
                    <button class="w-8 h-8 rounded hover:bg-surface flex items-center justify-center text-muted hover:text-header relative group" onclick="UI.modal('settings')">
                        <i class="fa-solid fa-gear text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 3.3 MAIN CHAT AREA -->
        <div class="flex-1 flex flex-col bg-bg relative min-w-0">
            <header class="h-12 px-4 flex items-center justify-between shadow-sm border-b border-border z-10 shrink-0 bg-bg">
                <div class="flex items-center gap-2 overflow-hidden">
                    <i class="fa-solid fa-hashtag text-muted text-xl" id="header-icon"></i>
                    <div>
                        <div class="font-bold text-header text-sm truncate" id="header-title">general</div>
                        <div class="text-xs text-muted truncate hidden md:block" id="header-desc">General discussion about the project.</div>
                    </div>
                    <div class="hidden md:flex items-center gap-1 text-xs text-muted ml-4 pl-4 border-l border-border h-6">
                        <i class="fa-solid fa-users text-[10px]"></i>
                        <span id="header-member-count">0 Members Online</span>
                    </div>
                </div>
                <div class="flex items-center gap-4 text-muted text-lg">
                    <button class="bg-accent hover:bg-accentHover text-white text-xs font-bold px-3 py-1 rounded hidden md:block" onclick="UI.createInvite()">Invite People</button>
                    <i class="fa-solid fa-phone cursor-pointer hover:text-header transition-colors" title="Start Call" onclick="UI.toast('Join a Voice Channel first!')"></i>
                    <i class="fa-solid fa-video cursor-pointer hover:text-header transition-colors" title="Video Call" onclick="UI.toast('Join a Voice Channel first!')"></i>
                    <i class="fa-solid fa-thumbtack cursor-pointer hover:text-header transition-colors" title="Pinned Messages" onclick="UI.togglePins()"></i>
                    <i class="fa-solid fa-users cursor-pointer hover:text-header transition-colors lg:hidden" onclick="UI.toggleMembers()"></i>
                    <div class="bg-border rounded px-2 py-0.5 flex items-center w-36 transition-all focus-within:w-56">
                        <input type="text" id="search-box" placeholder="Search" class="bg-transparent border-none outline-none text-xs text-text w-full h-6" oninput="Chat.search(this.value)">
                        <i class="fa-solid fa-magnifying-glass text-xs"></i>
                    </div>
                </div>
            </header>

            <div id="main-view" class="flex-1 relative overflow-hidden">
                <div id="chat-scroll" class="absolute inset-0 scroller flex flex-col p-4 space-y-[2px] pb-6">
                    <div class="mt-auto"></div>
                    <div class="mb-8 px-4 opacity-80 select-none">
                        <div class="w-16 h-16 bg-surface rounded-full flex items-center justify-center mb-4">
                            <i class="fa-solid fa-hashtag text-4xl text-header" id="welcome-icon"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-header mb-1">Welcome to <span id="welcome-channel">general</span>!</h1>
                        <p class="text-muted">This is the start of the <span class="text-header font-bold"><span id="welcome-channel-2">general</span></span> channel.</p>
                    </div>
                    <div id="messages-feed" class="w-full flex flex-col"></div>
                </div>

                <div id="voice-grid" class="absolute inset-0 bg-black hidden flex-wrap content-center justify-center gap-4 p-8">
                    <div class="w-64 h-48 bg-sidebar rounded-lg border-2 border-success relative overflow-hidden flex items-center justify-center group shadow-elevation-high">
                        <video id="local-video" class="w-full h-full object-cover hidden" autoplay muted></video>
                        <img id="local-avatar-lg" src="" class="w-20 h-20 rounded-full">
                        <div class="absolute bottom-2 left-2 bg-black/50 px-2 rounded text-white text-xs font-bold">You</div>
                        <div class="absolute bottom-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="p-1 bg-black/50 rounded text-white" onclick="UI.toggleVideo()"><i class="fa-solid fa-video-slash"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="markdown-toolbar" class="absolute bottom-20 left-4 flex gap-1 bg-sidebar border border-border rounded p-1 shadow-popout z-30 hidden">
                <button class="w-6 h-6 hover:bg-surface rounded text-muted hover:text-header text-xs font-bold" onclick="Chat.insertMarkdown('**')">B</button>
                <button class="w-6 h-6 hover:bg-surface rounded text-muted hover:text-header text-xs italic" onclick="Chat.insertMarkdown('*')">I</button>
                <button class="w-6 h-6 hover:bg-surface rounded text-muted hover:text-header text-xs line-through" onclick="Chat.insertMarkdown('~~')">S</button>
                <button class="w-6 h-6 hover:bg-surface rounded text-muted hover:text-header text-xs font-mono" onclick="Chat.insertMarkdown('`')">&lt;&gt;</button>
            </div>

            <div class="p-4 pt-0 z-20 bg-bg shrink-0" id="chat-input-area">
                <div id="reply-bar" class="hidden bg-sidebar border border-border border-b-0 rounded-t-lg p-2 flex items-center justify-between px-4 text-xs animate-slide-up">
                    <span class="text-muted">Replying to <strong class="text-accent" id="reply-name">User</strong></span>
                    <i class="fa-solid fa-circle-xmark cursor-pointer text-muted hover:text-danger text-sm" onclick="Chat.cancelReply()"></i>
                </div>
                <div id="edit-bar" class="hidden bg-sidebar border border-border border-b-0 rounded-t-lg p-2 flex items-center justify-between px-4 text-xs animate-slide-up">
                    <span class="text-muted">Editing Message</span>
                    <i class="fa-solid fa-circle-xmark cursor-pointer text-muted hover:text-danger text-sm" onclick="Chat.cancelEdit()"></i>
                </div>
                <div class="bg-surface rounded-lg flex items-start p-2 border border-transparent focus-within:border-accent/50 relative transition-colors shadow-elevation-low">
                    <button class="w-8 h-8 rounded-full hover:text-header text-muted flex items-center justify-center transition-colors mt-0.5 relative overflow-hidden group" onclick="UI.togglePlusMenu()">
                        <i class="fa-solid fa-circle-plus text-xl group-hover:rotate-90 transition-transform duration-200"></i>
                    </button>
                    
                    <div id="plus-menu" class="absolute bottom-12 left-0 bg-sidebar border border-border rounded-lg shadow-popout hidden flex-col w-48 z-50 overflow-hidden">
                        <div class="p-2 hover:bg-accent hover:text-white cursor-pointer flex items-center gap-2 text-sm text-muted" onclick="UI.modal('link-resource')">
                            <i class="fa-solid fa-upload"></i> Upload File (Link)
                        </div>
                        <div class="p-2 hover:bg-accent hover:text-white cursor-pointer flex items-center gap-2 text-sm text-muted" onclick="UI.modal('code-snippet')">
                            <i class="fa-solid fa-code"></i> Code Snippet
                        </div>
                        <div class="p-2 hover:bg-accent hover:text-white cursor-pointer flex items-center gap-2 text-sm text-muted" onclick="UI.modal('video-share')">
                            <i class="fa-brands fa-youtube"></i> Share Video
                        </div>
                    </div>

                    <textarea id="msg-input" rows="1" class="flex-1 bg-transparent border-none outline-none text-text text-[15px] mx-2 py-1.5 resize-none max-h-[40vh] scroller" placeholder="Message" onfocus="document.getElementById('markdown-toolbar').classList.remove('hidden')" onblur="setTimeout(()=>document.getElementById('markdown-toolbar').classList.add('hidden'), 200)" oninput="Chat.handleTyping()"></textarea>
                    <div class="flex items-center gap-2 mt-0.5 pr-1 text-muted">
                        <button class="hover:text-accent transition-colors" title="Gift Nitro"><i class="fa-solid fa-gift text-lg"></i></button>
                        <button class="hover:text-accent transition-colors" title="Sticker"><i class="fa-solid fa-sticky-note text-lg"></i></button>
                        <button class="hover:text-warning transition-colors" title="Emoji" onclick="UI.toggleEmojiPicker()"><i class="fa-solid fa-face-smile text-lg"></i></button>
                    </div>
                </div>
                <div class="text-[10px] text-muted mt-1 ml-1 h-4 transition-all" id="typing-indicator"></div>
            </div>
        </div>

        <!-- 3.4 MEMBER LIST -->
        <aside id="member-sidebar" class="w-60 bg-sidebar border-l border-border hidden lg:flex flex-col shrink-0 scroller">
            <div id="member-list-content" class="p-3 pt-6 min-h-full">
                <div class="animate-pulse space-y-4">
                    <div class="h-4 bg-surface rounded w-20"></div>
                    <div class="flex gap-2"><div class="w-8 h-8 rounded-full bg-surface"></div><div class="h-4 bg-surface rounded w-32 mt-2"></div></div>
                    <div class="flex gap-2"><div class="w-8 h-8 rounded-full bg-surface"></div><div class="h-4 bg-surface rounded w-32 mt-2"></div></div>
                </div>
            </div>
        </aside>

        <!-- 3.5 PINNED MESSAGES -->
        <aside id="pins-sidebar" class="w-80 bg-sidebar border-l border-border hidden flex-col shrink-0 shadow-2xl absolute right-0 h-full z-40 animate-slide-right">
            <div class="p-4 border-b border-border flex justify-between items-center bg-header/5">
                <h3 class="font-bold text-header">Pinned Messages</h3>
                <i class="fa-solid fa-xmark cursor-pointer text-muted hover:text-header" onclick="UI.togglePins()"></i>
            </div>
            <div class="flex-1 p-4 text-center text-muted text-sm italic">
                No pinned messages yet.
            </div>
        </aside>

    </div>

    <!-- LAYER 4: MODALS -->

    <!-- 4.1 Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 z-[2000] bg-black/50 hidden items-center justify-center animate-fade-in flex">
        <div class="glass-modal w-[900px] h-[650px] rounded-[8px] flex overflow-hidden relative animate-scale-in">
            <div class="w-[240px] bg-sidebar p-4 pt-8 flex flex-col gap-0.5 border-r border-border">
                <div class="text-xs font-bold text-muted uppercase px-2 mb-1">User Settings</div>
                <button class="text-left px-2.5 py-1.5 text-sm text-header bg-surface rounded cursor-pointer font-medium flex items-center gap-2" onclick="UI.switchSettingsTab('account')"><i class="fa-solid fa-user w-4"></i> My Account</button>
                <button class="text-left px-2.5 py-1.5 text-sm text-muted hover:bg-surface hover:text-header rounded cursor-pointer font-medium flex items-center gap-2" onclick="UI.switchSettingsTab('profile')"><i class="fa-solid fa-pen-nib w-4"></i> Profile</button>
                <button class="text-left px-2.5 py-1.5 text-sm text-muted hover:bg-surface hover:text-header rounded cursor-pointer font-medium flex items-center gap-2" onclick="UI.switchSettingsTab('privacy')"><i class="fa-solid fa-lock w-4"></i> Privacy</button>
                
                <div class="h-px bg-border my-2 mx-2"></div>
                
                <div class="text-xs font-bold text-muted uppercase px-2 mb-1">App Settings</div>
                <button class="text-left px-2.5 py-1.5 text-sm text-muted hover:bg-surface hover:text-header rounded cursor-pointer font-medium flex items-center gap-2" onclick="UI.switchSettingsTab('appearance')"><i class="fa-solid fa-palette w-4"></i> Appearance</button>
                <button class="text-left px-2.5 py-1.5 text-sm text-muted hover:bg-surface hover:text-header rounded cursor-pointer font-medium flex items-center gap-2" onclick="UI.switchSettingsTab('themes')"><i class="fa-solid fa-brush w-4"></i> Themes</button>
                <button class="text-left px-2.5 py-1.5 text-sm text-muted hover:bg-surface hover:text-header rounded cursor-pointer font-medium flex items-center gap-2" onclick="UI.switchSettingsTab('admin')" id="btn-admin-panel"><i class="fa-solid fa-shield-halved w-4"></i> GOD MODE <span class="text-[10px] bg-danger text-white px-1 rounded ml-auto">ADMIN</span></button>
                <button class="text-left px-2.5 py-1.5 text-sm text-muted hover:bg-surface hover:text-header rounded cursor-pointer font-medium flex items-center gap-2" onclick="UI.modal('changelog')"><i class="fa-solid fa-star w-4"></i> What's New</button>
                
                <div class="h-px bg-border my-2 mx-2"></div>
                
                <button onclick="Auth.logout()" class="text-left px-2.5 py-1.5 text-sm text-danger hover:bg-danger/10 rounded cursor-pointer font-medium flex justify-between items-center">
                    Log Out <i class="fa-solid fa-right-from-bracket"></i>
                </button>
                
                <div class="mt-auto px-2 text-[10px] text-muted">
                    AuthFlow Desktop<br>
                    Build 24.0.0 (Sentinel)<br>
                    <span class="text-link cursor-pointer hover:underline" onclick="UI.modal('credits')">Credits</span>
                </div>
            </div>
            
            <div class="flex-1 bg-bg p-10 overflow-y-auto scroller relative" id="settings-content">
                <div class="absolute top-4 right-4 flex flex-col items-center group cursor-pointer" onclick="UI.closeModals()">
                    <div class="w-8 h-8 rounded-full border-2 border-muted flex items-center justify-center group-hover:bg-muted group-hover:text-white transition-all text-muted">
                        <i class="fa-solid fa-xmark"></i>
                    </div>
                    <span class="text-[10px] font-bold text-muted mt-1 uppercase">Esc</span>
                </div>

                <div id="tab-account">
                    <h2 class="text-xl font-bold text-header mb-6">My Account</h2>
                    <div class="h-24 bg-accent rounded-t-lg relative w-full overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-accent to-purple-600 opacity-80"></div>
                        <div class="absolute -bottom-8 left-6">
                            <div class="relative group cursor-pointer" onclick="Profile.randomizeAvatar()">
                                <img id="set-avatar-preview" src="" class="w-20 h-20 rounded-full border-[6px] border-bg bg-sidebar object-cover">
                                <div class="absolute bottom-0 right-0 w-6 h-6 bg-success rounded-full border-[4px] border-bg"></div>
                                <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 text-white text-xs font-bold z-10">EDIT</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-surface rounded-b-lg p-4 pt-10 mb-8 border border-border">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <div class="text-xl font-bold text-header flex items-center gap-2">
                                    <span id="set-name-disp">Username</span>
                                    <span id="set-badge-container"></span>
                                </div>
                                <div class="text-sm text-muted" id="set-tag-disp">#0000</div>
                            </div>
                            <button class="bg-accent hover:bg-accentHover text-white px-4 py-1.5 rounded text-sm font-medium transition-colors" onclick="Profile.save()">Save Changes</button>
                        </div>
                        <div class="bg-bg rounded p-3 space-y-4 border border-border">
                            <div class="flex justify-between items-center">
                                <div class="flex-1 mr-4">
                                    <div class="text-xs font-bold text-muted uppercase">Display Name</div>
                                    <div class="text-sm text-header"><input id="input-set-name" class="bg-transparent border-none outline-none text-header w-full focus:bg-black/20 rounded px-1" value="..."></div>
                                </div>
                                <button class="bg-surface hover:bg-border px-3 py-1 rounded text-xs text-header">Edit</button>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex-1 mr-4">
                                    <div class="text-xs font-bold text-muted uppercase">Avatar URL</div>
                                    <div class="text-sm text-header truncate"><input id="input-set-avatar" class="bg-transparent border-none outline-none text-muted w-full focus:bg-black/20 rounded px-1" value="..."></div>
                                </div>
                                <button class="bg-surface hover:bg-border px-3 py-1 rounded text-xs text-header">Edit</button>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex-1 mr-4">
                                    <div class="text-xs font-bold text-muted uppercase">Custom Status</div>
                                    <div class="text-sm text-header truncate"><input id="input-set-status" class="bg-transparent border-none outline-none text-muted w-full focus:bg-black/20 rounded px-1" placeholder="What's happening?"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-profile" class="hidden">
                    <h2 class="text-xl font-bold text-header mb-6">Profile Customization</h2>
                    <div class="flex gap-6">
                        <div class="flex-1">
                            <div class="mb-4">
                                <label class="block text-xs font-bold text-muted uppercase mb-2">About Me</label>
                                <textarea id="input-set-bio" class="w-full h-24 bg-surface border border-border rounded p-2 text-sm text-header outline-none focus:border-accent" placeholder="Tell us about yourself..."></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block text-xs font-bold text-muted uppercase mb-2">Banner Color</label>
                                <input type="color" id="input-set-banner" class="w-full h-10 bg-surface border border-border rounded cursor-pointer">
                            </div>
                            <button class="bg-accent hover:bg-accentHover text-white px-4 py-2 rounded text-sm font-bold" onclick="Profile.save()">Save Profile</button>
                        </div>
                        <div class="w-64">
                            <div class="text-xs font-bold text-muted uppercase mb-2">Preview</div>
                            <div class="w-full bg-sidebar rounded-lg shadow-lg overflow-hidden border border-black">
                                <div class="h-16 bg-accent" id="preview-banner"></div>
                                <div class="px-4 pb-4">
                                    <div class="-mt-8 mb-2">
                                        <img id="preview-avatar" src="" class="w-16 h-16 rounded-full border-[4px] border-sidebar bg-bg object-cover">
                                    </div>
                                    <div class="font-bold text-header text-sm" id="preview-name">User</div>
                                    <div class="text-xs text-muted mb-2">#0000</div>
                                    <div class="h-px bg-border mb-2"></div>
                                    <div class="text-xs font-bold text-muted uppercase mb-1">About Me</div>
                                    <div class="text-xs text-text" id="preview-bio">...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-privacy" class="hidden">
                    <h2 class="text-xl font-bold text-header mb-6">Privacy & Safety</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-header font-medium">Allow Direct Messages</div>
                                <div class="text-muted text-xs">Allow people to send you DMs.</div>
                            </div>
                            <input type="checkbox" checked class="accent-accent w-5 h-5">
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-header font-medium">Filter Explicit Content</div>
                                <div class="text-muted text-xs">Scan messages for inappropriate content.</div>
                            </div>
                            <input type="checkbox" checked class="accent-accent w-5 h-5">
                        </div>
                    </div>
                </div>

                <div id="tab-appearance" class="hidden">
                    <h2 class="text-lg font-bold text-header mb-4">Appearance</h2>
                    <div class="mb-6">
                        <div class="flex justify-between mb-2">
                            <label class="text-xs font-bold text-muted uppercase">App Scaling (Zoom)</label>
                            <span class="text-xs font-bold text-accent" id="zoom-value">100%</span>
                        </div>
                        <input type="range" min="0.75" max="1.25" step="0.05" value="1" class="w-full accent-accent h-2 bg-surface rounded-lg appearance-none cursor-pointer" oninput="UI.setZoom(this.value)">
                    </div>
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <div class="text-header font-medium">RGB Gamer Mode</div>
                                <div class="text-muted text-xs">Make everything rainbow.</div>
                            </div>
                            <input type="checkbox" class="accent-accent w-5 h-5" onchange="document.body.classList.toggle('rgb-mode')">
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <div class="text-header font-medium">Compact Mode</div>
                                <div class="text-muted text-xs">Hide avatars for density.</div>
                            </div>
                            <input type="checkbox" class="accent-accent w-5 h-5" onchange="document.body.classList.toggle('compact-mode')">
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-header font-medium">Bubble Chat</div>
                                <div class="text-muted text-xs">Use WhatsApp style bubbles.</div>
                            </div>
                            <input type="checkbox" class="accent-accent w-5 h-5" onchange="document.body.classList.toggle('bubble-mode')">
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1 h-24 bg-[#313338] border-2 border-accent rounded-lg cursor-pointer flex items-center justify-center font-bold text-white relative" onclick="Theme.set('midnight')">Midnight</div>
                        <div class="flex-1 h-24 bg-white border border-border rounded-lg cursor-pointer flex items-center justify-center font-bold text-black hover:border-muted transition-colors" onclick="Theme.set('light')">Light</div>
                        <div class="flex-1 h-24 bg-[#2b213a] border border-border rounded-lg cursor-pointer flex items-center justify-center font-bold text-pink-400 hover:border-pink-500 transition-colors" onclick="Theme.set('synthwave')">Synth</div>
                    </div>
                </div>

                <div id="tab-themes" class="hidden">
                     <h2 class="text-xl font-bold text-header mb-6">Create Custom Theme</h2>
                     <div class="grid grid-cols-2 gap-4">
                         <div>
                             <label class="text-xs font-bold text-muted uppercase">Background</label>
                             <input type="color" id="theme-bg" class="w-full h-10 mt-1 cursor-pointer bg-surface border border-border rounded">
                         </div>
                         <div>
                             <label class="text-xs font-bold text-muted uppercase">Sidebar</label>
                             <input type="color" id="theme-sidebar" class="w-full h-10 mt-1 cursor-pointer bg-surface border border-border rounded">
                         </div>
                         <div>
                             <label class="text-xs font-bold text-muted uppercase">Panel/Inputs</label>
                             <input type="color" id="theme-panel" class="w-full h-10 mt-1 cursor-pointer bg-surface border border-border rounded">
                         </div>
                         <div>
                             <label class="text-xs font-bold text-muted uppercase">Text Color</label>
                             <input type="color" id="theme-text" class="w-full h-10 mt-1 cursor-pointer bg-surface border border-border rounded">
                         </div>
                         <div class="col-span-2">
                             <label class="text-xs font-bold text-muted uppercase">Accent Color (Brand)</label>
                             <input type="color" id="theme-accent" class="w-full h-10 mt-1 cursor-pointer bg-surface border border-border rounded">
                         </div>
                     </div>
                     <button class="mt-6 w-full bg-accent hover:bg-accentHover text-white py-2 rounded font-bold" onclick="Theme.createCustom()">Apply Custom Theme</button>
                     <div class="mt-4 p-3 bg-warn/10 text-warn border border-warn/30 rounded text-sm">
                         <i class="fa-solid fa-triangle-exclamation"></i> Custom themes are saved locally to your browser.
                     </div>
                </div>

                <div id="tab-admin" class="hidden">
                    <h2 class="text-xl font-bold text-danger mb-6 flex items-center gap-2"><i class="fa-solid fa-shield-halved"></i> God Mode Dashboard</h2>
                    
                    <div class="bg-bg p-4 rounded border border-border mb-6">
                        <h3 class="font-bold text-header mb-2">Owner Customization</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-muted uppercase">Name Color (Hex)</label>
                                <input id="admin-name-color" type="text" class="w-full bg-surface border border-border rounded p-2 text-sm text-header mt-1" placeholder="#FF0000">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-muted uppercase">Custom Role Title</label>
                                <input id="admin-role-name" type="text" class="w-full bg-surface border border-border rounded p-2 text-sm text-header mt-1" placeholder="GOD">
                            </div>
                        </div>
                        <button class="bg-accent hover:bg-accentHover text-white px-4 py-1.5 rounded text-sm font-bold mt-3" onclick="Profile.saveAdmin()">Apply Customization</button>
                    </div>

                    <div class="space-y-4 mb-6">
                        <div class="bg-bg p-4 rounded border border-border">
                            <h3 class="font-bold text-header mb-4">User Management & Moderation</h3>
                            <div id="admin-user-list" class="max-h-64 overflow-y-auto scroller space-y-1">
                                <!-- Populated via JS -->
                                <div class="text-muted text-sm text-center py-4">Loading users...</div>
                            </div>
                            <button class="mt-2 text-xs text-link hover:underline" onclick="Admin.refreshUsers()"><i class="fa-solid fa-rotate"></i> Refresh List</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-bg p-4 rounded border border-border">
                            <h3 class="font-bold text-header mb-2">System Control</h3>
                            <button class="w-full bg-danger text-white px-4 py-2 rounded text-sm font-bold mb-2" onclick="UI.toast('Lockdown initiated (Simulation)', 'warn')">EMERGENCY LOCKDOWN</button>
                            <button class="w-full bg-surface hover:bg-white/10 text-white px-4 py-2 rounded text-sm font-bold" onclick="Admin.nukeChat()">Nuke Current Chat</button>
                        </div>
                        <div class="bg-bg p-4 rounded border border-border">
                            <h3 class="font-bold text-header mb-2">Global Broadcast</h3>
                            <input id="admin-broadcast-msg" type="text" class="w-full bg-surface border border-border rounded p-2 text-sm text-header mb-2" placeholder="Message to all servers...">
                            <button class="w-full bg-accent text-white px-4 py-2 rounded text-sm font-bold" onclick="Admin.broadcast()">Send Broadcast</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Server Settings Modal -->
    <div id="modal-server-settings" class="fixed inset-0 z-[2000] bg-black/70 hidden items-center justify-center">
        <div class="bg-surface w-[500px] rounded-lg overflow-hidden shadow-2xl animate-scale-in">
             <div class="p-6">
                 <h2 class="font-bold text-header text-2xl mb-4">Server Overview</h2>
                 
                 <div class="mb-4">
                     <label class="block text-xs font-bold text-muted uppercase mb-2">Server Name</label>
                     <input id="settings-group-name" class="w-full bg-bg border border-black/30 rounded p-2 text-header outline-none focus:border-accent" disabled>
                 </div>
                 
                 <div class="mb-4">
                     <label class="block text-xs font-bold text-muted uppercase mb-2">Invite Code</label>
                     <div class="flex gap-2">
                         <input id="settings-group-code" class="flex-1 bg-bg border border-black/30 rounded p-2 text-header outline-none text-center font-mono cursor-text" readonly>
                         <button class="bg-accent text-white px-4 rounded font-bold text-sm" onclick="Groups.copyCode()">Copy</button>
                     </div>
                 </div>

                 <div class="p-3 bg-bg rounded border border-border mb-4 text-sm text-muted">
                     Only the Owner can modify server details. <span id="settings-is-owner" class="text-success hidden font-bold">(You are Owner)</span>
                 </div>
             </div>
             <div class="bg-bg p-4 flex justify-between items-center">
                 <button class="bg-danger hover:bg-red-600 text-white px-4 py-2 rounded text-sm font-bold" onclick="Groups.leave()">Leave Server</button>
                 <div class="flex gap-2">
                     <button class="text-sm font-medium text-header hover:underline mr-4" onclick="UI.closeModals()">Close</button>
                     <button id="btn-save-server" class="bg-accent hover:bg-accentHover text-white px-6 py-2 rounded-[3px] text-sm font-bold hidden" onclick="Groups.updateSettings()">Save</button>
                 </div>
             </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="modal-group-create" class="fixed inset-0 z-[2000] bg-black/70 hidden items-center justify-center">
        <div class="bg-surface w-[440px] rounded-lg overflow-hidden shadow-2xl animate-scale-in">
            <div class="p-6 text-center">
                <h2 class="font-bold text-header text-2xl mb-2">Create Your Server</h2>
                <p class="text-muted text-sm mb-6">Your server is where you and your friends hang out. Make yours and start talking.</p>
                
                <div class="flex justify-center mb-6">
                    <div class="w-24 h-24 rounded-full border-2 border-dashed border-muted flex items-center justify-center cursor-pointer hover:border-header hover:bg-white/5 transition-all relative">
                        <i class="fa-solid fa-camera text-2xl text-muted"></i>
                        <div class="absolute -top-2 -right-2 bg-accent rounded-full w-6 h-6 flex items-center justify-center text-white text-xs font-bold">+</div>
                    </div>
                </div>

                <div class="text-left mb-4">
                    <label class="text-xs font-bold text-muted uppercase mb-2 block">Server Name</label>
                    <input id="create-group-name" class="w-full bg-bg border border-black/30 rounded p-2 text-header outline-none focus:border-accent" placeholder="My Awesome Server">
                </div>
                
                <div class="text-left flex items-center justify-between bg-bg p-2 rounded border border-border">
                    <div>
                        <div class="text-sm font-bold text-header">Private Server</div>
                        <div class="text-xs text-muted">Requires invite code to join.</div>
                    </div>
                    <input type="checkbox" id="create-group-private" class="accent-accent w-5 h-5">
                </div>
            </div>
            <div class="bg-bg p-4 flex justify-between items-center">
                <button class="text-sm font-medium text-header hover:underline" onclick="UI.closeModals()">Back</button>
                <button class="bg-accent hover:bg-accentHover text-white px-6 py-2 rounded-[3px] text-sm font-bold" onclick="Groups.create()">Create</button>
            </div>
        </div>
    </div>

    <!-- Join Server Modal -->
    <div id="modal-join-server" class="fixed inset-0 z-[2000] bg-black/70 hidden items-center justify-center">
        <div class="bg-surface w-[440px] rounded-lg overflow-hidden shadow-2xl animate-scale-in">
            <div class="p-6 text-center">
                <h2 class="font-bold text-header text-2xl mb-2">Join a Server</h2>
                <p class="text-muted text-sm mb-6">Enter an invite code below to join an existing server.</p>
                
                <div class="text-left mb-2">
                    <label class="text-xs font-bold text-muted uppercase mb-2 block">Invite Code</label>
                    <input id="join-group-code" class="w-full bg-bg border border-black/30 rounded p-2 text-header outline-none focus:border-accent" placeholder="h3ll0w0rld">
                </div>
            </div>
            <div class="bg-bg p-4 flex justify-between items-center">
                <button class="text-sm font-medium text-header hover:underline" onclick="UI.closeModals()">Back</button>
                <button class="bg-accent hover:bg-accentHover text-white px-6 py-2 rounded-[3px] text-sm font-bold" onclick="Groups.join()">Join Server</button>
            </div>
        </div>
    </div>

    <!-- Create Channel Modal -->
    <div id="modal-create-channel" class="fixed inset-0 z-[2000] bg-black/70 hidden items-center justify-center">
        <div class="bg-surface w-[440px] rounded-lg overflow-hidden shadow-2xl animate-scale-in">
            <div class="p-4 flex justify-between items-center">
                <h2 class="font-bold text-header text-base">Create Channel</h2>
                <i class="fa-solid fa-xmark text-muted hover:text-header cursor-pointer text-lg" onclick="UI.closeModals()"></i>
            </div>
            <div class="px-4 pb-4">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-muted uppercase mb-2">Channel Type</label>
                    <div class="bg-bg p-3 rounded flex items-center justify-between hover:bg-border/50 cursor-pointer border border-border/50 mb-2" onclick="document.getElementById('ctype-text').checked = true">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-hashtag text-xl text-muted"></i>
                            <div>
                                <div class="text-sm font-medium text-header">Text</div>
                                <div class="text-xs text-muted">Post images, GIFS, opinions, and puns.</div>
                            </div>
                        </div>
                        <input type="radio" id="ctype-text" name="ctype" value="text" checked class="accent-accent w-5 h-5">
                    </div>
                    <div class="bg-bg p-3 rounded flex items-center justify-between hover:bg-border/50 cursor-pointer border border-border/50" onclick="document.getElementById('ctype-voice').checked = true">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-volume-high text-xl text-muted"></i>
                            <div>
                                <div class="text-sm font-medium text-header">Voice</div>
                                <div class="text-xs text-muted">Hang out together with voice, video, and screen share.</div>
                            </div>
                        </div>
                        <input type="radio" id="ctype-voice" name="ctype" value="voice" class="accent-accent w-5 h-5">
                    </div>
                </div>
                <div class="mb-2">
                    <label class="block text-xs font-bold text-muted uppercase mb-2">Channel Name</label>
                    <div class="bg-bg p-2 rounded border border-black flex items-center gap-1">
                        <i class="fa-solid fa-hashtag text-muted"></i>
                        <input id="create-channel-name" class="bg-transparent border-none outline-none text-header text-sm w-full" placeholder="new-channel">
                    </div>
                </div>
            </div>
            <div class="bg-bg p-4 flex justify-end gap-4">
                <button class="text-sm font-medium text-header hover:underline" onclick="UI.closeModals()">Cancel</button>
                <button class="bg-accent hover:bg-accentHover text-white px-6 py-2 rounded-[3px] text-sm font-bold" onclick="Channels.create()">Create Channel</button>
            </div>
        </div>
    </div>

    <!-- Code Snippet Modal -->
    <div id="modal-code-snippet" class="fixed inset-0 z-[2000] bg-black/70 hidden items-center justify-center">
        <div class="bg-surface w-[600px] rounded-lg overflow-hidden shadow-2xl animate-scale-in">
            <div class="p-4 border-b border-border flex justify-between items-center">
                <h2 class="font-bold text-header text-base">Insert Code Snippet</h2>
                <i class="fa-solid fa-xmark text-muted hover:text-header cursor-pointer" onclick="UI.closeModals()"></i>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-muted uppercase mb-2">Language</label>
                    <input id="code-lang" class="w-full bg-bg border border-black/30 rounded p-2 text-header outline-none focus:border-accent" placeholder="javascript, python, html...">
                </div>
                <div>
                    <label class="block text-xs font-bold text-muted uppercase mb-2">Code</label>
                    <textarea id="code-body" class="w-full h-48 bg-bg border border-black/30 rounded p-2 text-header outline-none focus:border-accent font-mono text-sm" placeholder="console.log('Hello World');"></textarea>
                </div>
            </div>
            <div class="bg-bg p-4 flex justify-end gap-4">
                <button class="text-sm font-medium text-header hover:underline" onclick="UI.closeModals()">Cancel</button>
                <button class="bg-accent hover:bg-accentHover text-white px-6 py-2 rounded-[3px] text-sm font-bold" onclick="Chat.insertCode()">Insert</button>
            </div>
        </div>
    </div>
    
    <!-- Code Viewer Modal (Sandboxed) -->
    <div id="modal-code-viewer" class="fixed inset-0 z-[6000] bg-black/90 hidden items-center justify-center p-8">
        <div class="bg-[#1e1e1e] w-full max-w-4xl h-[80vh] rounded-lg flex flex-col shadow-2xl animate-scale-in border border-border">
            <div class="h-10 bg-[#252526] flex items-center justify-between px-4 border-b border-[#333]">
                <span class="text-sm font-mono text-white">Code Runner / Viewer (Secure)</span>
                <i class="fa-solid fa-xmark text-muted hover:text-white cursor-pointer" onclick="UI.closeModals()"></i>
            </div>
            <iframe id="code-viewer-frame" class="w-full flex-1 bg-white" sandbox="allow-scripts allow-same-origin"></iframe>
        </div>
    </div>
    
    <!-- Video Share Modal -->
    <div id="modal-video-share" class="fixed inset-0 z-[2000] bg-black/70 hidden items-center justify-center">
        <div class="bg-surface w-[500px] rounded-lg overflow-hidden shadow-2xl animate-scale-in">
            <div class="p-4 border-b border-border flex justify-between items-center">
                <h2 class="font-bold text-header text-base">Share Video (YouTube/MP4)</h2>
                <i class="fa-solid fa-xmark text-muted hover:text-header cursor-pointer" onclick="UI.closeModals()"></i>
            </div>
            <div class="p-4">
                <p class="text-muted text-sm mb-4">Paste a YouTube link or a direct MP4 URL to embed a video player.</p>
                <div class="mb-2">
                    <label class="block text-xs font-bold text-muted uppercase mb-2">Video URL</label>
                    <input id="video-url" class="w-full bg-bg border border-black/30 rounded p-2 text-header outline-none focus:border-accent" placeholder="https://youtu.be/...">
                </div>
            </div>
            <div class="bg-bg p-4 flex justify-end gap-4">
                <button class="text-sm font-medium text-header hover:underline" onclick="UI.closeModals()">Cancel</button>
                <button class="bg-accent hover:bg-accentHover text-white px-6 py-2 rounded-[3px] text-sm font-bold" onclick="Chat.insertVideo()">Share</button>
            </div>
        </div>
    </div>

    <!-- Link Resource Modal -->
    <div id="modal-link-resource" class="fixed inset-0 z-[2000] bg-black/70 hidden items-center justify-center">
        <div class="bg-surface w-[500px] rounded-lg overflow-hidden shadow-2xl animate-scale-in">
            <div class="p-4 border-b border-border flex justify-between items-center">
                <h2 class="font-bold text-header text-base">Upload via Link</h2>
                <i class="fa-solid fa-xmark text-muted hover:text-header cursor-pointer" onclick="UI.closeModals()"></i>
            </div>
            <div class="p-4">
                <p class="text-muted text-sm mb-4">Since we don't use paid storage, paste a direct link to your image or file (Google Drive, Imgur, etc).</p>
                <div class="mb-2">
                    <label class="block text-xs font-bold text-muted uppercase mb-2">Direct URL</label>
                    <input id="resource-url" class="w-full bg-bg border border-black/30 rounded p-2 text-header outline-none focus:border-accent" placeholder="https://example.com/image.png">
                </div>
            </div>
            <div class="bg-bg p-4 flex justify-end gap-4">
                <button class="text-sm font-medium text-header hover:underline" onclick="UI.closeModals()">Cancel</button>
                <button class="bg-accent hover:bg-accentHover text-white px-6 py-2 rounded-[3px] text-sm font-bold" onclick="Chat.insertMedia()">Embed</button>
            </div>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="modal-changelog" class="fixed inset-0 z-[2000] bg-black/70 hidden items-center justify-center">
        <div class="bg-surface w-[600px] rounded-lg overflow-hidden shadow-2xl animate-scale-in">
            <div class="h-40 bg-accent relative flex items-end p-6">
                <i class="fa-solid fa-rocket text-white text-6xl absolute top-4 right-6 opacity-20 rotate-12"></i>
                <div>
                    <div class="text-white font-bold text-2xl">What's New</div>
                    <div class="text-white/80 text-sm">November 2025 Update</div>
                </div>
                <i class="fa-solid fa-xmark text-white/80 hover:text-white cursor-pointer absolute top-4 right-4 text-xl" onclick="UI.closeModals()"></i>
            </div>
            <div class="p-6 bg-bg max-h-[400px] overflow-y-auto scroller">
                <div class="mb-6">
                    <h3 class="text-header font-bold text-lg mb-2">⚡ Sentinel Update (Secure)</h3>
                    <ul class="list-disc list-inside text-muted text-sm space-y-1">
                        <li><strong>Admin Dashboard:</strong> Kick/Ban users directly.</li>
                        <li><strong>Security Fixed:</strong> XSS prevention engine rewritten.</li>
                        <li><strong>DMs Fixed:</strong> Direct Messaging now works reliably.</li>
                        <li><strong>Popout Fixed:</strong> User info loads correctly.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Lightbox -->
    <div id="lightbox" class="fixed inset-0 z-[6000] bg-black/90 hidden items-center justify-center" onclick="this.classList.add('hidden'); this.classList.remove('flex')">
        <img id="lightbox-img" src="" class="max-w-[90vw] max-h-[90vh] rounded shadow-2xl">
    </div>

    <!-- User Popout -->
    <div id="user-popout" class="fixed z-[4000] w-80 bg-sidebar rounded-lg shadow-2xl hidden flex-col overflow-hidden border border-black">
        <div class="h-16 bg-accent relative">
            <div class="absolute -bottom-5 left-4">
                <div class="relative">
                    <img id="pop-avatar" src="" class="w-20 h-20 rounded-full border-[6px] border-sidebar bg-bg object-cover">
                    <div class="absolute bottom-1 right-1 w-4 h-4 bg-success rounded-full border-[3px] border-sidebar"></div>
                </div>
            </div>
        </div>
        <div class="pt-10 px-4 pb-4 bg-sidebar">
            <div class="text-lg font-bold text-header" id="pop-name">User</div>
            <div class="text-xs text-muted" id="pop-tag">#0000</div>
            <div class="my-3 h-px bg-border"></div>
            <div class="text-xs font-bold text-muted uppercase mb-1">About Me</div>
            <div class="text-sm text-text mb-4 break-words" id="pop-bio">Loading...</div>
            <div class="text-xs font-bold text-muted uppercase mb-1">Roles</div>
            <div class="flex gap-1 mb-4" id="pop-roles"></div>
            <input type="text" class="w-full bg-bg border border-border rounded p-2 text-xs text-header mb-2" placeholder="Send a message to @User" disabled>
        </div>
    </div>

    <!-- Emoji Picker -->
    <div id="emoji-picker" class="fixed hidden bg-surface border border-border w-80 h-96 rounded-lg shadow-popout z-[1500] flex-col overflow-hidden animate-slide-up" style="bottom: 80px; right: 20px;">
        <div class="bg-bg p-3 border-b border-border">
            <input type="text" placeholder="Find the perfect emoji" class="w-full bg-sidebar border-none outline-none rounded px-2 py-1 text-sm text-header placeholder-muted focus:ring-1 focus:ring-accent">
        </div>
        <div class="flex-1 overflow-y-auto scroller p-3">
            <div class="text-xs font-bold text-muted uppercase mb-2">People</div>
            <div class="grid grid-cols-8 gap-1 text-xl cursor-pointer select-none" id="emoji-grid-people"></div>
            <div class="text-xs font-bold text-muted uppercase mt-4 mb-2">Nature</div>
            <div class="grid grid-cols-8 gap-1 text-xl cursor-pointer select-none" id="emoji-grid-nature"></div>
            <div class="text-xs font-bold text-muted uppercase mt-4 mb-2">Objects</div>
            <div class="grid grid-cols-8 gap-1 text-xl cursor-pointer select-none" id="emoji-grid-objects"></div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="ctx-menu" class="fixed bg-[#111214] border border-border rounded-[4px] w-56 shadow-popout hidden z-[5000] py-1.5 animate-scale-in origin-top-left"></div>

    <!-- Autocomplete Menu -->
    <div id="autocomplete-menu" class="fixed bg-sidebar border border-border rounded shadow-popout hidden flex-col w-48 z-[3000] max-h-40 overflow-y-auto scroller"></div>

    <!-- ================================================================================= -->
    <!-- JAVASCRIPT LOGIC ENGINE (MONOLITH)                                                -->
    <!-- ================================================================================= -->
    <script>
        const CFG = {
            firebase: {
                apiKey: "AIzaSyBHtMi26uj419KG3wxDM83F3QyXzI0xsaE",
                authDomain: "global-chat-84a9d.firebaseapp.com",
                databaseURL: "https://global-chat-84a9d-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "global-chat-84a9d",
                storageBucket: "global-chat-84a9d.firebasestorage.app",
                messagingSenderId: "238768987082",
                appId: "1:238768987082:web:e50a37cdf1af2e435b8d33"
            },
            OWNER_UID: "uIgAETp55KQU4wweQQfWX0IhaWG3", 
            EMOJIS: {
                people: ["😀","😃","😄","😁","😆","😅","😂","🤣","🥲","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🥸","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡"],
                nature: ["🐶","🐱","🐭","🐹","🐰","🦊","🐻","🐼","🐻‍❄️","🐨","🐯","🦁","🐮","🐷","🐸","🐵","🐔","🐧","🐦","🐤","🦆","🦅","🦉","🦇","🐺","🐗","🐴","🦄","🐝","🪱","🐛","🦋","🐌","🐞","🐜","🪰","🪲","🪳","🦟","🦗","🕷️","🕸️","🦂","🐢","🐍","🦎","🦖","🦕","🐙","🦑"],
                objects: ["⌚","📱","💻","⌨️","🖥️","🖨️","🖱️","🖲️","🕹️","🗜️","💽","💾","💿","📀","📼","📷","📸","📹","🎥","📽️","🎞️","📞","☎️","📟","📠","📺","📻","🎙️","🎚️","🎛️","🧭","⏱️","⏲️","⏰","🕰️","⌛","⏳","📡","🔋","🔌","💡","🔦","🕯️","🪔","🧯","🛢️","💸","💵","💴","💶","💷"]
            },
            LIMITS: { MAX_GROUPS_FREE: 1, MAX_GROUPS_NITRO: 99 },
            TIPS: [
                "Did you know this website was made by 1 person? ItsSkellyHer3!",
                "Right-click a message to reply or delete it.",
                "Type code blocks with ``` to share snippets!",
                "Upgrade to Nitro for unlimited servers!",
                "Admins can now ban/kick users from the settings."
            ]
        };

        const Sound = {
            play: function(type) {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                if(type === 'msg') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.1);
                } else if (type === 'join') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(400, ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(600, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.05, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.2);
                }
            }
        };

        const Storage = {
            save: function(key, val) { localStorage.setItem(`af_${key}`, JSON.stringify(val)); },
            load: function(key) { try { return JSON.parse(localStorage.getItem(`af_${key}`)); } catch(e) { return null; } }
        };

        const State = {
            user: null, userData: null, db: null,
            view: 'server', activeGroup: null, activeChannel: null, activeVoice: null,
            groups: {}, channels: {},
            listeners: [], channelListener: null, replyCtx: null, editMsgId: null,
            localStream: null,
            isDev: false, isRegisterMode: false, lastMsg: 0, typingTimeout: null
        };

        /* --- MODULE: BOOTSTRAP --- */
        const Boot = {
            run: function() {
                try {
                    console.log("%c AUTHFLOW DESKTOP %c v24.0.0 ", "background:#5865F2; color:white; font-weight:bold; padding:4px;", "background:#333; color:white; padding:4px;");
                    if(!firebase.apps.length) {
                        try { firebase.initializeApp(CFG.firebase); } 
                        catch(e) { document.getElementById('force-entry-btn').classList.remove('hidden'); }
                    }
                    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    State.db = firebase.database();
                    this.rotateTips();
                    this.initParticles();

                    const savedZoom = Storage.load('zoom');
                    if(savedZoom) UI.setZoom(savedZoom);
                    else if(window.innerWidth < 1400) UI.setZoom(0.9);

                    setTimeout(() => {
                        if(document.getElementById('boot-layer').style.display !== 'none') {
                            document.getElementById('force-entry-btn').classList.remove('hidden');
                            document.getElementById('boot-status').innerText = "Connection slow...";
                        }
                    }, 3000);

                    firebase.auth().onAuthStateChanged(user => {
                        if(user) {
                            State.user = user;
                            document.getElementById('auth-layer').style.display = 'none';
                            this.ensureMembership(user).then(() => {
                                this.loadUserData(user.uid).then(() => {
                                    setTimeout(() => {
                                        document.getElementById('boot-layer').style.opacity = 0;
                                        setTimeout(()=>document.getElementById('boot-layer').style.display='none', 500);
                                        document.getElementById('app-layer').style.display = 'flex';
                                        setTimeout(()=>document.getElementById('app-layer').style.opacity=1, 50);
                                        App.start();
                                    }, 1500);
                                });
                            });
                        } else {
                            setTimeout(() => {
                                document.getElementById('boot-layer').style.display='none';
                                document.getElementById('auth-layer').style.display='flex';
                            }, 800);
                        }
                    });
                    this.attachGlobalListeners();
                } catch(e) { document.getElementById('force-entry-btn').classList.remove('hidden'); }
            },
            ensureMembership: async function(user) {
                const snap = await State.db.ref('groups').once('value');
                let inGroup = false;
                let hubId = null;
                snap.forEach(s => {
                    const g = s.val();
                    if(g.name === "Global Hub") hubId = s.key;
                    if(g.members && g.members[user.uid]) inGroup = true;
                });
                if(!inGroup) {
                    if(hubId) await State.db.ref(`groups/${hubId}/members/${user.uid}`).set(true);
                    else {
                        const newRef = State.db.ref('groups').push();
                        await newRef.set({
                            name: "Global Hub", owner: "system", created: Date.now(),
                            icon: "https://ui-avatars.com/api/?name=Global+Hub&background=5865F2&color=fff",
                            members: { [user.uid]: true }
                        });
                        await State.db.ref(`channels/${newRef.key}`).push({ name: 'general', type: 'text', topic: 'Welcome!' });
                    }
                }
            },
            forceEntry: function() {
                document.getElementById('boot-layer').style.display = 'none';
                document.getElementById('auth-layer').style.display = 'flex';
            },
            rotateTips: function() {
                let i = 0;
                const el = document.getElementById('boot-tip');
                if(!el) return;
                el.innerText = CFG.TIPS[0];
                setInterval(() => {
                    i = (i + 1) % CFG.TIPS.length;
                    el.style.opacity = 0;
                    setTimeout(() => { el.innerText = CFG.TIPS[i]; el.style.opacity = 0.8; }, 500);
                }, 4000);
            },
            initParticles: function() {
                const canvas = document.getElementById('particles-canvas');
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                const particles = [];
                for(let i=0; i<50; i++) particles.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5, size: Math.random()*2});
                function animate() {
                    ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = 'rgba(255,255,255,0.1)';
                    particles.forEach(p => {
                        p.x += p.vx; p.y += p.vy;
                        if(p.x < 0) p.x = canvas.width; if(p.x > canvas.width) p.x = 0;
                        if(p.y < 0) p.y = canvas.height; if(p.y > canvas.height) p.y = 0;
                        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                    });
                    requestAnimationFrame(animate);
                }
                animate();
            },
            loadUserData: async function(uid) {
                try {
                    const snap = await State.db.ref(`users/${uid}`).once('value');
                    if(snap.exists()) {
                        State.userData = snap.val();
                        if(!State.userData.statusMsg) State.userData.statusMsg = "";
                    } else {
                        State.userData = {
                            name: State.user.displayName || State.user.email.split('@')[0] || 'Anonymous',
                            avatar: State.user.photoURL || `https://ui-avatars.com/api/?name=${uid}`,
                            role: 'user', bio: 'This user has not set a bio.', statusMsg: '', bannerColor: '#5865F2', created: Date.now()
                        };
                        await State.db.ref(`users/${uid}`).set(State.userData);
                    }
                    if(uid !== CFG.OWNER_UID) {
                        const btn = document.getElementById('btn-admin-panel');
                        if(btn) btn.remove();
                    } else {
                        const nameEl = document.getElementById('current-user-name');
                        if(nameEl) nameEl.classList.add('rainbow-text');
                    }
                } catch(e) {
                    State.userData = { name: 'Guest', avatar: `https://ui-avatars.com/api/?name=Guest`, role: 'user' };
                }
            },
            attachGlobalListeners: function() {
                const input = document.getElementById('msg-input');
                if(input) {
                    input.addEventListener('keydown', (e) => {
                        if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); Chat.send(); }
                        if(e.key === '@' || e.key === ':') UI.showAutocomplete(e.key);
                    });
                    input.addEventListener('input', function() {
                        this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';
                        if(this.value === '') this.style.height = 'auto';
                    });
                }
                window.addEventListener('dragover', e => e.preventDefault());
                window.addEventListener('drop', e => { e.preventDefault(); }); // Simplified drop for brevity in this patch
                window.addEventListener('click', () => {
                    ['ctx-menu', 'plus-menu', 'status-menu', 'user-popout', 'autocomplete-menu'].forEach(id => {
                        const el = document.getElementById(id);
                        if(el) { el.classList.add('hidden'); el.classList.remove('flex'); }
                    });
                });
            }
        };

        const App = {
            start: function() {
                Theme.init(); Groups.sync(); Profile.sync(); Emoji.init();
                if(State.db && State.user) {
                    const cRef = State.db.ref('.info/connected');
                    cRef.on('value', s => {
                        if(s.val()) {
                            const statusRef = State.db.ref(`users/${State.user.uid}/status`);
                            statusRef.onDisconnect().set('offline'); statusRef.set('online');
                        }
                    });
                }
            }
        };

        const Auth = {
            toggleMode: function() {
                State.isRegisterMode = !State.isRegisterMode;
                document.getElementById('auth-title').innerText = State.isRegisterMode ? "Create an Account" : "Welcome Back!";
                document.getElementById('btn-auth-action').innerText = State.isRegisterMode ? "Register" : "Log In";
                document.getElementById('btn-auth-action').onclick = State.isRegisterMode ? Auth.registerEmail : Auth.loginEmail;
            },
            loginEmail: function() {
                const e = document.getElementById('login-email').value, p = document.getElementById('login-pass').value;
                if(!e || !p) return UI.toast("Fill fields", "danger");
                firebase.auth().signInWithEmailAndPassword(e, p).catch(err => UI.toast(err.message, "danger"));
            },
            registerEmail: function() {
                const e = document.getElementById('login-email').value, p = document.getElementById('login-pass').value;
                if(!e || !p) return UI.toast("Fill fields", "danger");
                firebase.auth().createUserWithEmailAndPassword(e, p).catch(err => UI.toast(err.message, "danger"));
            },
            google: () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider).catch(e => UI.toast(e.message, "danger"));
            },
            anon: () => firebase.auth().signInAnonymously().catch(e => UI.toast(e.message, "danger")),
            logout: () => {
                localStorage.removeItem('af_last_group');
                if(State.user) State.db.ref(`users/${State.user.uid}/status`).set('offline').then(() => firebase.auth().signOut().then(() => location.reload()));
                else location.reload();
            }
        };

        const Theme = {
            init: function() {
                const t = localStorage.getItem('af_theme') || 'midnight';
                this.set(t);
            },
            set: function(name) {
                document.documentElement.setAttribute('data-theme', name);
                localStorage.setItem('af_theme', name);
                if(name === 'custom') {
                    const custom = JSON.parse(localStorage.getItem('af_custom_theme') || '{}');
                    this.applyCustomVars(custom);
                }
            },
            createCustom: function() {
                const theme = {
                    bg: document.getElementById('theme-bg').value,
                    sidebar: document.getElementById('theme-sidebar').value,
                    panel: document.getElementById('theme-panel').value,
                    text: document.getElementById('theme-text').value,
                    accent: document.getElementById('theme-accent').value
                };
                localStorage.setItem('af_custom_theme', JSON.stringify(theme));
                this.applyCustomVars(theme);
                this.set('custom');
                UI.toast("Custom Theme Applied!", "success");
            },
            applyCustomVars: function(t) {
                const r = document.documentElement.style;
                if(t.bg) r.setProperty('--custom-bg', t.bg);
                if(t.sidebar) r.setProperty('--custom-sidebar', t.sidebar);
                if(t.panel) r.setProperty('--custom-panel', t.panel);
                if(t.text) r.setProperty('--custom-text', t.text);
                if(t.accent) r.setProperty('--custom-accent', t.accent);
            }
        };

        const Admin = {
            refreshUsers: function() {
                const list = document.getElementById('admin-user-list');
                list.innerHTML = '<div class="text-center text-muted">Fetching...</div>';
                State.db.ref('users').once('value', s => {
                    list.innerHTML = '';
                    s.forEach(snap => {
                        const u = snap.val();
                        const uid = snap.key;
                        const div = document.createElement('div');
                        div.className = "flex items-center justify-between bg-surface p-2 rounded mb-1";
                        div.innerHTML = `
                            <div class="flex items-center gap-2">
                                <img src="${u.avatar}" class="w-6 h-6 rounded-full">
                                <span class="text-sm font-bold text-header">${u.name}</span>
                                <span class="text-xs text-muted font-mono">${uid.substring(0,5)}</span>
                            </div>
                            <div class="flex gap-1">
                                <button class="bg-warn text-white px-2 py-0.5 rounded text-xs" onclick="Admin.mute('${uid}')">Mute</button>
                                <button class="bg-orange-500 text-white px-2 py-0.5 rounded text-xs" onclick="Admin.kick('${uid}')">Kick</button>
                                <button class="bg-danger text-white px-2 py-0.5 rounded text-xs" onclick="Admin.ban('${uid}')">Ban</button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                });
            },
            ban: (uid) => {
                if(confirm("Ban User? This is permanent.")) {
                    // In a real app, you'd set a flag in DB. Here we simulate.
                    State.db.ref(`users/${uid}/banned`).set(true);
                    UI.toast("User Banned (Simulated DB write)", "success");
                }
            },
            kick: (uid) => UI.toast("User Kicked (Simulation)", "warn"),
            mute: (uid) => UI.toast("User Muted (Simulation)", "warn"),
            broadcast: () => {
                const msg = document.getElementById('admin-broadcast-msg').value;
                if(msg && State.activeChannel) {
                    State.db.ref(`messages/${State.activeChannel}`).push({
                        text: `## 📢 BROADCAST\n${msg}`,
                        uid: "SYSTEM", name: "System", avatar: "https://ui-avatars.com/api/?name=System&background=ff0000&color=fff",
                        role: "admin", ts: Date.now()
                    });
                    UI.toast("Broadcast Sent", "success");
                }
            },
            nukeChat: () => {
                if(confirm("DELETE ALL MESSAGES in this channel?")) {
                    State.db.ref(`messages/${State.activeChannel}`).remove();
                    UI.toast("Channel Nuked", "success");
                }
            }
        };

        const Groups = {
            sync: function() {
                State.db.ref('groups').on('value', s => {
                    const list = document.getElementById('server-list');
                    list.innerHTML = '';
                    State.groups = {};
                    let first = null;
                    let hasGroups = false;

                    s.forEach(snap => {
                        const g = {id: snap.key, ...snap.val()};
                        if(g.private && !g.members?.[State.user.uid] && g.owner !== State.user.uid) return;
                        hasGroups = true;
                        State.groups[g.id] = g;
                        if(!first) first = g;

                        const isActive = State.activeGroup === g.id && State.view === 'server';
                        const initials = g.name.substring(0,2).toUpperCase();
                        const isGlobal = g.name === "AuthFlow";
                        const el = document.createElement('div');
                        el.className = "group relative cursor-pointer w-full flex justify-center";
                        el.onclick = () => Groups.select(g.id);
                        el.innerHTML = `
                            <div class="absolute left-0 top-1/2 -translate-y-1/2 w-[4px] ${isActive ? 'h-[40px]' : 'h-[8px] group-hover:h-[20px]'} bg-header rounded-r transition-all duration-200"></div>
                            <div class="w-12 h-12 ${isActive ? 'bg-accent rounded-[16px]' : 'bg-sidebar group-hover:bg-accent rounded-[24px] group-hover:rounded-[16px]'} transition-all duration-200 flex items-center justify-center text-header font-bold text-sm shadow-lg overflow-hidden relative">
                                ${g.icon ? `<img src="${g.icon}" class="w-full h-full object-cover">` : initials}
                                ${isGlobal ? '<div class="absolute bottom-0 right-0 text-[10px] text-white bg-blue-500 rounded-full w-4 h-4 flex items-center justify-center border border-sidebar"><i class="fa-solid fa-check"></i></div>' : ''}
                            </div>
                            <div class="absolute left-full top-1/2 -translate-y-1/2 ml-4 bg-black text-white text-xs font-bold px-2 py-1 rounded shadow-xl opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity whitespace-nowrap z-50">${g.name}</div>
                        `;
                        list.appendChild(el);
                    });

                    if(State.activeGroup === null) {
                        const lastGroup = Storage.load('last_group');
                        if(lastGroup && State.groups[lastGroup]) Groups.select(lastGroup);
                        else if(first) Groups.select(first.id);
                    }
                });
            },
            select: function(gid) {
                State.view = 'server';
                State.activeGroup = gid;
                Storage.save('last_group', gid);
                
                document.getElementById('home-indicator').classList.remove('h-[40px]');
                document.getElementById('home-icon').classList.remove('bg-accent', 'rounded-[16px]');
                
                const g = State.groups[gid];
                if(g) document.getElementById('server-name').innerHTML = g.name + (g.name === "AuthFlow" ? ' <i class="fa-solid fa-circle-check text-blue-500 text-xs"></i>' : '');
                Channels.sync(gid);
            },
            create: function() {
                const name = document.getElementById('create-group-name').value;
                if(!name) return UI.toast("Name required", "warn");
                const ref = State.db.ref('groups').push();
                ref.set({
                    name: name, owner: State.user.uid, created: Date.now(),
                    icon: `https://ui-avatars.com/api/?name=${name}&background=random`,
                    private: document.getElementById('create-group-private').checked,
                    inviteCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                    members: { [State.user.uid]: true }
                }).then(() => {
                    State.db.ref(`channels/${ref.key}`).push({ name: 'general', type: 'text', topic: 'General chat' });
                    UI.closeModals();
                });
            },
            join: function() {
                const code = document.getElementById('join-group-code').value.toUpperCase();
                if(!code) return;
                State.db.ref('groups').once('value', s => {
                    let found = false;
                    s.forEach(snap => {
                        const g = snap.val();
                        if(g.inviteCode === code) {
                            found = true;
                            State.db.ref(`groups/${snap.key}/members/${State.user.uid}`).set(true);
                            UI.toast("Joined Server!", "success");
                            UI.closeModals();
                        }
                    });
                    if(!found) UI.toast("Invalid Invite Code", "danger");
                });
            },
            updateSettings: function() {
                if(!State.activeGroup) return;
                if(State.groups[State.activeGroup].owner !== State.user.uid) return UI.toast("Permission Denied", "danger");
                const newName = document.getElementById('settings-group-name').value;
                if(newName) State.db.ref(`groups/${State.activeGroup}/name`).set(newName).then(() => { UI.toast("Updated", "success"); UI.closeModals(); });
            },
            leave: function() {
                 if(!State.activeGroup) return;
                 if(State.groups[State.activeGroup].owner === State.user.uid) return UI.toast("Owner cannot leave.", "danger");
                 if(confirm(`Leave server?`)) {
                     State.db.ref(`groups/${State.activeGroup}/members/${State.user.uid}`).remove().then(() => {
                         UI.toast("Left Server", "success");
                         UI.closeModals();
                         location.reload(); 
                     });
                 }
            },
            copyCode: function() {
                const c = document.getElementById('settings-group-code');
                c.select(); document.execCommand('copy'); UI.toast("Copied!", "success");
            }
        };

        const Channels = {
            sync: function(gid) {
                const container = document.getElementById('channel-container');
                if(!container) return;
                container.innerHTML = '';
                if(State.channelListener && typeof State.channelListener.off === 'function') State.channelListener.off();
                
                const ref = State.db.ref(`channels/${gid}`);
                State.channelListener = ref;
                ref.on('value', s => {
                    container.innerHTML = `<div class="px-2 pt-2 mb-1 text-xs font-bold text-muted uppercase flex items-center group">Text Channels <i class="fa-solid fa-plus ml-auto opacity-0 group-hover:opacity-100 cursor-pointer" onclick="UI.modal('create-channel'); event.stopPropagation();"></i></div>`;
                    State.channels = {};
                    let first = null;

                    s.forEach(snap => {
                        const c = {id: snap.key, ...snap.val()};
                        State.channels[c.id] = c;
                        if(!first && c.type === 'text') first = c;
                        const isActive = State.activeChannel === c.id;
                        const isVoice = c.type === 'voice';
                        
                        const el = document.createElement('div');
                        el.className = `channel-item flex items-center px-2 mx-2 py-1.5 rounded cursor-pointer mb-0.5 group ${isActive ? 'bg-active text-white' : 'text-muted hover:bg-surface hover:text-text'}`;
                        el.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if(isVoice) Voice.join(c); else Channels.join(c.id);
                        });
                        
                        let icon = isVoice ? 'fa-volume-high' : 'fa-hashtag';
                        el.innerHTML = `<i class="fa-solid ${icon} text-lg mr-1.5 text-muted ${isActive ? 'text-white' : ''}"></i><span class="truncate font-medium text-[15px] flex-1 pointer-events-none">${c.name}</span>`;
                        if(isVoice) { el.id = `vc-${c.id}`; el.innerHTML += `<div id="vc-users-${c.id}" class="flex flex-col ml-4"></div>`; }
                        container.appendChild(el);
                    });

                    const lastChannel = Storage.load(`last_channel_${gid}`);
                    if(lastChannel && State.channels[lastChannel]) Channels.join(lastChannel);
                    else if(!State.activeChannel && first) Channels.join(first.id);
                });
            },
            join: function(cid) {
                State.activeChannel = cid;
                Storage.save(`last_channel_${State.activeGroup}`, cid);
                const c = State.channels[cid];
                if(!c) return;
                document.getElementById('header-title').innerText = c.name;
                document.getElementById('header-desc').innerText = c.topic || "";
                document.getElementById('welcome-channel').innerText = c.name;
                document.getElementById('welcome-channel-2').innerText = c.name;
                Chat.load(cid, 'server');
                UI.playSfx('click');
            },
            create: function() {
                const name = document.getElementById('create-channel-name').value.toLowerCase().replace(/\s/g, '-');
                if(!name) return;
                State.db.ref(`channels/${State.activeGroup}`).push({
                    name: name, type: document.querySelector('input[name="ctype"]:checked').value, topic: `Welcome to #${name}!`
                });
                UI.closeModals();
            }
        };

        const DMs = {
            init: function() {
                const container = document.getElementById('channel-container');
                container.innerHTML = `<div class="px-2 pt-2 mb-1 text-xs font-bold text-muted uppercase flex items-center">Direct Messages</div>`;
                State.db.ref('users').once('value', s => {
                    s.forEach(snap => {
                        const u = snap.val();
                        const uid = snap.key;
                        if(uid === State.user.uid) return;
                        const el = document.createElement('div');
                        el.className = `channel-item flex items-center px-2 mx-2 py-1.5 rounded cursor-pointer mb-0.5 group text-muted hover:bg-surface hover:text-text`;
                        el.onclick = () => DMs.open(uid, u);
                        el.innerHTML = `<div class="relative mr-2"><img src="${u.avatar}" class="w-8 h-8 rounded-full"><div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-success border-[2px] border-sidebar rounded-full"></div></div><span class="truncate font-medium text-[15px] flex-1">${u.name}</span>`;
                        container.appendChild(el);
                    });
                });
            },
            open: function(targetUid, u) {
                // Deterministic ID Generator for DMs
                const ids = [State.user.uid, targetUid].sort();
                const dmId = `dm_${ids[0]}_${ids[1]}`;
                State.activeChannel = dmId;
                document.getElementById('header-title').innerText = u.name;
                Chat.load(dmId, 'dm');
            }
        };

        const Voice = {
            join: function(c) {
                if(State.activeVoice === c.id) return;
                State.activeVoice = c.id;
                document.getElementById('voice-panel').classList.remove('hidden');
                document.getElementById('voice-panel').classList.add('flex');
                document.getElementById('voice-channel-name').innerText = c.name + " / Voice";
                const container = document.getElementById(`vc-users-${c.id}`);
                if(container) container.innerHTML = `<div class="flex items-center gap-2 pl-6 py-1 mt-1" id="vc-local-avatar"><img src="${State.userData.avatar}" class="w-5 h-5 rounded-full"><span class="text-xs text-white font-bold">${State.userData.name}</span></div>`;
                State.db.ref(`voiceStates/${State.activeGroup}/${c.id}/${State.user.uid}`).set({ name: State.userData.name, avatar: State.userData.avatar, mic: true });
                Sound.play('join');
                
                State.db.ref(`voiceStates/${State.activeGroup}/${c.id}`).on('value', s => {
                    const grid = document.getElementById('voice-grid');
                    const local = grid.firstElementChild;
                    grid.innerHTML = '';
                    grid.appendChild(local);
                    s.forEach(snap => {
                        if(snap.key === State.user.uid) return;
                        const u = snap.val();
                        const el = document.createElement('div');
                        el.className = "w-64 h-48 bg-sidebar rounded-lg border border-black relative overflow-hidden flex items-center justify-center group shadow-elevation-high animate-fade-in";
                        el.innerHTML = `<img src="${u.avatar}" class="w-20 h-20 rounded-full border-2 border-border"><div class="absolute bottom-2 left-2 bg-black/50 px-2 rounded text-white text-xs font-bold">${u.name}</div>`;
                        grid.appendChild(el);
                    });
                });
                document.getElementById('chat-scroll').classList.add('hidden');
                document.getElementById('voice-grid').classList.remove('hidden');
                document.getElementById('voice-grid').classList.add('flex');
                document.getElementById('chat-input-area').classList.add('hidden');
                this.startVisualizer();
            },
            leave: function() {
                if(!State.activeVoice) return;
                // Fix: Remove Local Avatar Instantly
                const localVC = document.getElementById('vc-local-avatar');
                if(localVC) localVC.remove();
                State.db.ref(`voiceStates/${State.activeGroup}/${State.activeVoice}/${State.user.uid}`).remove();
                State.db.ref(`voiceStates/${State.activeGroup}/${State.activeVoice}`).off();
                State.activeVoice = null;
                document.getElementById('voice-panel').classList.add('hidden');
                document.getElementById('voice-panel').classList.remove('flex');
                document.getElementById('chat-scroll').classList.remove('hidden');
                document.getElementById('voice-grid').classList.add('hidden');
                document.getElementById('voice-grid').classList.remove('flex');
                document.getElementById('chat-input-area').classList.remove('hidden');
            },
            startVisualizer: function() {
                const canvas = document.getElementById('voice-viz');
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
                function draw() {
                    if(!State.activeVoice) return;
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    ctx.fillStyle = '#23a559';
                    const bars = 20;
                    for(let i=0; i<bars; i++) {
                        const h = Math.random() * canvas.height;
                        ctx.fillRect(i * (canvas.width/bars), (canvas.height-h)/2, (canvas.width/bars)-2, h);
                    }
                    requestAnimationFrame(draw);
                }
                draw();
            }
        };

        const Chat = {
            load: function(id, type) {
                const feed = document.getElementById('messages-feed');
                feed.innerHTML = '';
                State.listeners.forEach(l => l.off()); State.listeners = [];

                if(type === 'server' && State.activeGroup) {
                    const groupUsersRef = State.db.ref(`presence/${State.activeGroup}`);
                    const myPresence = groupUsersRef.child(State.user.uid);
                    myPresence.onDisconnect().remove();
                    myPresence.set({ name: State.userData.name, avatar: State.userData.avatar, role: State.userData.role, statusMsg: State.userData.statusMsg || "", status: 'online', ts: Date.now() });

                    groupUsersRef.on('value', s => {
                        const mlist = document.getElementById('member-list-content');
                        const hCount = document.getElementById('header-member-count');
                        if(!mlist) return;
                        mlist.innerHTML = '';
                        const users = [];
                        let onlineCount = 0;
                        s.forEach(ss => { const val = ss.val(); if(val) { users.push({...val, uid: ss.key}); onlineCount++; } });
                        if(hCount) hCount.innerText = `${onlineCount} Members Online`;
                        users.forEach(u => {
                            // Fixed Popout Data Injection
                            const div = document.createElement('div');
                            div.className = "flex items-center gap-2 px-2 py-1.5 rounded hover:bg-surface cursor-pointer mb-1 group";
                            div.onclick = (e) => UI.showUserPopout(e, u.uid); // Pass UID instead of raw data
                            div.innerHTML = `<div class="relative"><img src="${u.avatar}" class="w-8 h-8 rounded-full bg-bg object-cover"><div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-success border-[3px] border-sidebar rounded-full"></div></div><div class="overflow-hidden"><div class="truncate text-sm font-medium text-text">${u.name}</div>${u.statusMsg ? `<div class="text-[10px] text-muted truncate">${u.statusMsg}</div>` : ''}</div>`;
                            mlist.appendChild(div);
                        });
                    });
                    State.listeners.push(groupUsersRef);
                } else {
                    document.getElementById('member-list-content').innerHTML = '<div class="p-4 text-muted text-sm text-center">Direct Message</div>';
                }

                const mRef = State.db.ref(`messages/${id}`).limitToLast(50);
                mRef.on('child_added', s => { Chat.renderMsg(s.key, s.val()); if(s.val().uid !== State.user.uid) Sound.play('msg'); });
                mRef.on('child_changed', s => { const el = document.getElementById(s.key); if(el) { el.remove(); Chat.renderMsg(s.key, s.val(), true); } });
                mRef.on('child_removed', s => document.getElementById(s.key)?.remove());
                State.listeners.push(mRef);
            },
            send: function() {
                const input = document.getElementById('msg-input');
                let text = input.value.trim();
                if(!State.activeChannel || !text) return;
                if(text.startsWith('/')) { Commands.parse(text); input.value = ''; return; }

                // SECURITY: We do NOT allow raw HTML input. 
                // Code Block Logic
                const codePattern = /^(\s*const|\s*let|\s*var|\s*function|\s*import|\s*class|<!DOCTYPE|<html|\/\*|#include)/;
                if(codePattern.test(text) && !text.startsWith('```')) text = "```\n" + text + "\n```";

                text = text.replace(/\{(\w+)\}([\s\S]*)/, (match, lang, code) => "```" + lang + "\n" + code + "\n```");

                State.db.ref(`messages/${State.activeChannel}`).push({
                    text, uid: State.user.uid, name: State.userData.name, avatar: State.userData.avatar,
                    role: State.userData.role, nameColor: State.userData.nameColor || null, customRole: State.userData.customRole || null,
                    ts: firebase.database.ServerValue.TIMESTAMP,
                    replyTo: State.replyCtx
                });
                input.value = ''; Chat.clearReply();
            },
            renderMsg: function(id, m, isUpdate = false) {
                if(!isUpdate && document.getElementById(id)) return;
                const feed = document.getElementById('messages-feed');
                
                // SECURITY PIPELINE
                let body = m.text || "";
                
                // 1. Escape HTML in code blocks BEFORE Markdown parsing to prevent script injection
                // This regex finds ``` blocks and sanitizes the content inside
                body = body.replace(/```([\s\S]*?)```/g, (match, content) => {
                    return "```" + content.replace(/</g, "&lt;").replace(/>/g, "&gt;") + "```";
                });

                // 2. Parse Markdown
                try { body = marked.parse(body); } catch(e) { body = m.text; }

                // 3. Post-Processing Replacements (Sanitized)
                body = body.replace(/<pre><code( class="language-(.*?)")?>([\s\S]*?)<\/code><\/pre>/g, (match, cls, lang, code) => {
                    // Decode escaped entities for display in textarea (copy) but keep escaped for highlight
                    const txt = document.createElement('textarea'); txt.innerHTML = code; 
                    const decodedRaw = txt.value;
                    
                    const safeCode = encodeURIComponent(decodedRaw);
                    return `<div class="mac-code-block"><div class="mac-header"><div class="mac-lights"><div class="light red"></div><div class="light yellow"></div><div class="light green"></div></div><div class="mac-actions"><span class="mac-lang">${lang || 'text'}</span><span class="mac-btn" onclick="UI.runCode('${safeCode}', '${lang}')"><i class="fa-solid fa-play"></i> Run</span><span class="mac-btn" onclick="UI.copyCode(this)"><i class="fa-regular fa-copy"></i> Copy</span></div></div><div class="mac-body"><pre><code>${code}</code></pre></div></div>`;
                });

                // Sanitize Final Output
                body = DOMPurify.sanitize(body, {ADD_TAGS: ['iframe'], ADD_ATTR: ['allow', 'allowfullscreen', 'frameborder', 'scrolling', 'onclick', 'class', 'src']});

                const row = document.createElement('div');
                row.className = `group flex gap-4 pl-4 pr-4 py-1 hover:bg-[rgba(0,0,0,0.06)] relative mt-[2px]`;
                row.id = id;
                
                // Safe HTML Construction
                row.innerHTML = `
                    <div class="w-full">
                        ${m.replyTo ? `<div class="flex items-center text-xs text-muted mb-1 opacity-80 gap-2 ml-14 relative"><div class="reply-elbow"></div><span class="text-accent font-bold ml-1">@${m.replyTo.name}</span></div>` : ''}
                        <div class="flex gap-4">
                            <div class="shrink-0 mt-0.5 cursor-pointer hover:opacity-80" onclick="UI.showUserPopout(event, '${m.uid}')"><img src="${m.avatar}" class="w-10 h-10 rounded-full bg-bg object-cover shadow-sm"></div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2"><span class="font-medium text-[16px] hover:underline cursor-pointer" style="${m.nameColor ? 'color:'+m.nameColor : ''}">${m.name}</span><span class="text-[11px] text-muted">${dayjs(m.ts).calendar()}</span></div>
                                <div class="msg-content text-text/90 leading-[1.375rem]">${body}</div>
                            </div>
                        </div>
                    </div>
                    <div class="absolute -top-2 right-4 bg-surface border border-border rounded shadow-popout flex opacity-0 group-hover:opacity-100 transition-opacity z-10 overflow-hidden">
                        <button class="p-1.5 px-2 hover:bg-hover text-muted" onclick="Chat.prepReply('${id}','${m.name}','...')"><i class="fa-solid fa-reply"></i></button>
                    </div>
                `;
                feed.appendChild(row);
                document.getElementById('chat-scroll').scrollTop = document.getElementById('chat-scroll').scrollHeight;
            },
            prepReply: function(id, name, text) {
                State.replyCtx = {id, name, text, avatar: State.userData.avatar}; 
                document.getElementById('reply-bar').classList.remove('hidden');
                document.getElementById('reply-bar').classList.add('flex');
                document.getElementById('reply-name').innerText = name;
            },
            cancelReply: function() {
                State.replyCtx = null;
                document.getElementById('reply-bar').classList.remove('flex');
                document.getElementById('reply-bar').classList.add('hidden');
            },
            clearReply: function() { this.cancelReply(); },
            insertCode: function() {
                const lang = document.getElementById('code-lang').value || 'text';
                const body = document.getElementById('code-body').value;
                if(body) { document.getElementById('msg-input').value = `{${lang}}${body}`; UI.closeModals(); Chat.send(); }
            },
            insertMarkdown: function(md) {
                const inp = document.getElementById('msg-input'); inp.value += md; inp.focus();
            }
        };

        const Profile = {
            sync: function() {
                if(!State.userData) return;
                const u = State.userData;
                document.getElementById('current-user-name').innerText = u.name;
                document.getElementById('current-user-av').src = u.avatar;
                document.getElementById('input-set-name').value = u.name;
                document.getElementById('input-set-avatar').value = u.avatar;
                document.getElementById('input-set-bio').value = u.bio || "";
                document.getElementById('input-set-status').value = u.statusMsg || "";
            },
            save: function() {
                const name = document.getElementById('input-set-name').value;
                const avatar = document.getElementById('input-set-avatar').value;
                const bio = document.getElementById('input-set-bio').value;
                const statusMsg = document.getElementById('input-set-status').value;
                const bannerColor = document.getElementById('input-set-banner').value;
                State.userData = { ...State.userData, name, avatar, bio, statusMsg, bannerColor };
                State.db.ref(`users/${State.user.uid}`).update(State.userData).then(() => { UI.toast("Saved", "success"); Profile.sync(); });
            },
            saveAdmin: function() {
                const nc = document.getElementById('admin-name-color').value;
                const cr = document.getElementById('admin-role-name').value;
                State.db.ref(`users/${State.user.uid}`).update({nameColor: nc, customRole: cr}).then(() => UI.toast("Applied", "success"));
            },
            randomizeAvatar: function() {
                const r = `https://ui-avatars.com/api/?background=random&name=${Math.random()}`;
                document.getElementById('input-set-avatar').value = r;
                document.getElementById('set-avatar-preview').src = r;
            }
        };

        const UI = {
            toast: function(msg, type='info') {
                const t = document.createElement('div');
                const bg = type === 'danger' ? 'bg-danger' : 'bg-bg';
                t.className = `fixed bottom-4 right-4 ${bg} text-white px-4 py-3 rounded shadow-lg z-[9999] animate-slide-up font-bold text-sm`;
                t.innerText = msg;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            },
            modal: function(id) {
                if(id === 'settings') { document.getElementById('modal-settings').classList.remove('hidden'); document.getElementById('modal-settings').classList.add('flex'); return; }
                if(id === 'server-settings') {
                    if(!State.activeGroup) return;
                    const g = State.groups[State.activeGroup];
                    document.getElementById('settings-group-name').value = g.name;
                    document.getElementById('settings-group-code').value = g.inviteCode || 'PUBLIC';
                    const isOwner = g.owner === State.user.uid;
                    document.getElementById('settings-group-name').disabled = !isOwner;
                    if(isOwner) document.getElementById('btn-save-server').classList.remove('hidden');
                    else document.getElementById('btn-save-server').classList.add('hidden');
                    document.getElementById('modal-server-settings').classList.remove('hidden');
                    document.getElementById('modal-server-settings').classList.add('flex');
                    return;
                }
                document.getElementById(`modal-${id}`).classList.remove('hidden');
                document.getElementById(`modal-${id}`).classList.add('flex');
            },
            closeModals: function() {
                document.querySelectorAll('[id^="modal-"]').forEach(m => { m.classList.add('hidden'); m.classList.remove('flex'); });
            },
            switchSettingsTab: function(tab) {
                ['account', 'profile', 'privacy', 'appearance', 'themes', 'admin'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
                if(tab === 'admin') Admin.refreshUsers();
            },
            switchView: function(v) {
                State.view = v;
                if(v === 'dm') {
                    document.getElementById('server-name').innerText = "Direct Messages";
                    DMs.init();
                } else if(State.activeGroup) Groups.select(State.activeGroup);
            },
            togglePlusMenu: () => document.getElementById('plus-menu').classList.toggle('hidden'),
            toggleEmojiPicker: () => document.getElementById('emoji-picker').classList.toggle('hidden'),
            toggleMembers: () => document.getElementById('member-sidebar').classList.toggle('hidden'),
            toggleVideo: () => Voice.toggleVideo(),
            toggleScreenShare: () => Voice.toggleScreenShare(),
            toggleStatusMenu: () => document.getElementById('status-menu').classList.toggle('hidden'),
            togglePins: () => document.getElementById('pins-sidebar').classList.toggle('hidden'),
            setZoom: (val) => { document.documentElement.style.setProperty('--app-zoom', val); Storage.save('zoom', val); },
            playSfx: (type) => Sound.play(type),
            copyCode: function(el) {
                const code = el.parentElement.parentElement.parentElement.querySelector('.mac-body').innerText;
                navigator.clipboard.writeText(code);
                UI.toast("Copied!", "success");
            },
            runCode: function(code, lang) {
                const decoded = decodeURIComponent(code);
                const frame = document.getElementById('code-viewer-frame');
                document.getElementById('modal-code-viewer').classList.remove('hidden');
                document.getElementById('modal-code-viewer').classList.add('flex');
                const content = (lang === 'html') ? decoded : `<html><body><script>${decoded}<\/script></body></html>`;
                const blob = new Blob([content], {type: 'text/html'});
                frame.src = URL.createObjectURL(blob);
            },
            showUserPopout: function(e, uid) {
                e.stopPropagation();
                // Fix: Fetch fresh data
                State.db.ref(`users/${uid}`).once('value', s => {
                    const u = s.val();
                    const p = document.getElementById('user-popout');
                    document.getElementById('pop-name').innerText = u.name;
                    document.getElementById('pop-avatar').src = u.avatar;
                    document.getElementById('pop-bio').innerText = u.bio || "No bio set.";
                    
                    const roles = document.getElementById('pop-roles');
                    roles.innerHTML = '';
                    if(u.role === 'owner') roles.innerHTML = '<span class="role-badge bg-[#E67E22]">OWNER</span>';
                    else if(u.role === 'admin') roles.innerHTML = '<span class="role-badge bg-[#E91E63]">ADMIN</span>';
                    else roles.innerHTML = '<span class="text-xs text-muted">User</span>';

                    let x = e.clientX + 20, y = e.clientY - 50;
                    if(x + 320 > window.innerWidth) x = e.clientX - 340;
                    if(y + 400 > window.innerHeight) y = window.innerHeight - 420;
                    p.style.left = `${x}px`; p.style.top = `${y}px`;
                    p.classList.remove('hidden'); p.classList.add('flex');
                });
            },
            showAutocomplete: (trigger) => {
                const menu = document.getElementById('autocomplete-menu');
                menu.style.left = '20px'; menu.style.bottom = '80px';
                menu.innerHTML = trigger === '@' ? '<div class="p-2 text-sm">User list...</div>' : '<div class="p-2 text-sm">Emoji list...</div>';
                menu.classList.remove('hidden'); menu.classList.add('flex');
            },
            insertAutocomplete: (text) => {
                document.getElementById('msg-input').value += text + ' ';
                document.getElementById('autocomplete-menu').classList.add('hidden');
            },
            openLightbox: (src) => {
                document.getElementById('lightbox-img').src = src;
                document.getElementById('lightbox').classList.remove('hidden');
                document.getElementById('lightbox').classList.add('flex');
            },
            ctxMsg: function(e, id, m) {
                e.preventDefault();
                const menu = document.getElementById('ctx-menu');
                menu.style.top = `${e.clientY}px`; menu.style.left = `${e.clientX}px`;
                menu.classList.remove('hidden');
                menu.innerHTML = `
                    <div class="text-[10px] font-bold text-muted uppercase px-2 py-1">Actions</div>
                    <div class="px-2 py-1 hover:bg-accent cursor-pointer" onclick="Chat.prepReply('${id}','${m.name}','')">Reply</div>
                    <div class="px-2 py-1 hover:bg-accent cursor-pointer" onclick="navigator.clipboard.writeText('${m.text}')">Copy Raw</div>
                `;
            }
        };

        window.onload = Boot.run.bind(Boot);
    </script>
</body>
</html>